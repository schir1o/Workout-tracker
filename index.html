<!DOCTYPE html>

<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schwarzes Loch - Planeten Simulation</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: #05050a; color: #e8e8ed; overflow: hidden; }

```
    .canvas-container { position: fixed; inset: 0; }
    canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
    #mainCanvas { cursor: crosshair; z-index: 2; }
    #bgCanvas { z-index: 1; }
    
    .panel { position: fixed; background: rgba(10,10,18,0.95); backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.08); border-radius: 14px; padding: 18px; box-shadow: 0 15px 50px rgba(0,0,0,0.5); }
    
    .control-panel { top: 16px; left: 16px; width: 300px; max-height: calc(100vh - 32px); overflow-y: auto; z-index: 100; }
    .control-panel::-webkit-scrollbar { width: 4px; }
    .control-panel::-webkit-scrollbar-thumb { background: #ff6b35; border-radius: 2px; }
    
    .panel-header { display: flex; align-items: center; gap: 12px; margin-bottom: 18px; padding-bottom: 14px; border-bottom: 1px solid rgba(255,255,255,0.08); }
    .panel-icon { width: 40px; height: 40px; border-radius: 50%; background: radial-gradient(circle at 30% 30%, #333, #000); box-shadow: 0 0 25px rgba(255,107,53,0.4); }
    .panel-title { font-size: 17px; font-weight: 600; }
    .panel-subtitle { font-size: 10px; color: #666; letter-spacing: 1px; text-transform: uppercase; margin-top: 2px; }
    
    .section { margin-bottom: 18px; }
    .section-title { font-size: 10px; font-weight: 600; color: #888; letter-spacing: 1.5px; text-transform: uppercase; margin-bottom: 12px; }
    
    .control { margin-bottom: 14px; }
    .control-label { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 12px; }
    .control-value { font-family: 'Consolas', monospace; font-size: 11px; color: #ff6b35; background: rgba(255,107,53,0.1); padding: 2px 7px; border-radius: 4px; }
    
    input[type="range"] { -webkit-appearance: none; width: 100%; height: 5px; background: rgba(255,255,255,0.1); border-radius: 3px; cursor: pointer; }
    input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 15px; height: 15px; background: #ff6b35; border-radius: 50%; cursor: pointer; box-shadow: 0 2px 8px rgba(255,107,53,0.4); }
    
    .toggle-row { display: flex; align-items: center; justify-content: space-between; padding: 7px 0; }
    .toggle { position: relative; width: 38px; height: 20px; cursor: pointer; }
    .toggle input { opacity: 0; width: 0; height: 0; }
    .toggle-slider { position: absolute; inset: 0; background: rgba(255,255,255,0.1); border-radius: 10px; transition: 0.2s; }
    .toggle-slider:before { content: ''; position: absolute; width: 14px; height: 14px; left: 3px; top: 3px; background: #666; border-radius: 50%; transition: 0.2s; }
    .toggle input:checked + .toggle-slider { background: #ff6b35; }
    .toggle input:checked + .toggle-slider:before { transform: translateX(18px); background: #fff; }
    
    .btn { padding: 9px 14px; border: none; border-radius: 7px; font-family: inherit; font-size: 11px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
    .btn-primary { background: #ff6b35; color: white; }
    .btn-primary:hover { background: #e55a2b; }
    .btn-secondary { background: rgba(255,255,255,0.05); color: #ccc; border: 1px solid rgba(255,255,255,0.1); }
    .btn-secondary:hover { background: rgba(255,255,255,0.1); }
    .btn-group { display: flex; gap: 8px; margin-top: 10px; }
    .btn-group .btn { flex: 1; }
    
    .spawner-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 7px; }
    .spawn-btn { aspect-ratio: 1; border-radius: 10px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px; transition: all 0.2s; color: #ccc; }
    .spawn-btn:hover { background: rgba(255,107,53,0.1); border-color: rgba(255,107,53,0.3); }
    .spawn-btn.active { background: #ff6b35; border-color: #ff6b35; color: white; }
    .spawn-btn .icon { width: 24px; height: 24px; border-radius: 50%; }
    .spawn-btn .label { font-size: 9px; }
    .spawn-btn.earth .icon { background: linear-gradient(135deg, #3b82f6, #22c55e); }
    .spawn-btn.mars .icon { background: linear-gradient(135deg, #dc2626, #ea580c); }
    .spawn-btn.jupiter .icon { background: linear-gradient(135deg, #d97706, #fbbf24); }
    .spawn-btn.star .icon { background: radial-gradient(circle, #fef3c7, #f59e0b); box-shadow: 0 0 10px rgba(251,191,38,0.5); }
    .spawn-btn.neutron .icon { background: radial-gradient(circle, #e0e7ff, #6366f1); box-shadow: 0 0 10px rgba(99,102,241,0.5); }
    .spawn-btn.asteroid .icon { background: linear-gradient(135deg, #57534e, #78716c); border-radius: 40% 60% 50% 50%; }
    
    .objects-list { max-height: 180px; overflow-y: auto; margin-top: 10px; }
    .object-item { display: flex; align-items: center; gap: 9px; padding: 9px; background: rgba(255,255,255,0.02); border-radius: 7px; margin-bottom: 5px; cursor: pointer; }
    .object-item:hover { background: rgba(255,255,255,0.05); }
    .object-item.selected { background: rgba(255,107,53,0.15); border: 1px solid rgba(255,107,53,0.3); }
    .object-dot { width: 10px; height: 10px; border-radius: 50%; }
    .object-info { flex: 1; }
    .object-name { font-size: 11px; font-weight: 500; }
    .object-status { font-size: 9px; color: #666; }
    .object-status.danger { color: #ef4444; }
    .object-status.warning { color: #fbbf24; }
    .object-delete { width: 20px; height: 20px; border: none; background: transparent; color: #666; cursor: pointer; border-radius: 4px; font-size: 12px; }
    .object-delete:hover { background: rgba(239,68,68,0.2); color: #ef4444; }
    
    .info-panel { top: 16px; right: 16px; width: 260px; z-index: 100; }
    .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 9px; }
    .info-item { background: rgba(255,255,255,0.02); border-radius: 9px; padding: 11px; }
    .info-item.full { grid-column: span 2; }
    .info-label { font-size: 9px; color: #666; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 3px; }
    .info-value { font-family: 'Consolas', monospace; font-size: 14px; font-weight: 500; }
    .info-value.accent { color: #ff6b35; }
    .info-value.danger { color: #ef4444; }
    .info-unit { font-size: 9px; color: #666; margin-left: 3px; }
    
    .selected-detail { margin-top: 14px; padding-top: 14px; border-top: 1px solid rgba(255,255,255,0.08); display: none; }
    .selected-detail.visible { display: block; }
    .selected-header { display: flex; align-items: center; gap: 9px; margin-bottom: 10px; }
    .selected-icon { width: 28px; height: 28px; border-radius: 50%; }
    .selected-name { font-size: 13px; font-weight: 600; }
    .selected-type { font-size: 10px; color: #666; }
    
    .timeline-panel { position: fixed; bottom: 16px; left: 50%; transform: translateX(-50%); padding: 12px 20px; display: flex; align-items: center; gap: 16px; z-index: 100; }
    .timeline-btn { width: 36px; height: 36px; border-radius: 50%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: #ccc; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
    .timeline-btn:hover, .timeline-btn.active { background: #ff6b35; border-color: #ff6b35; color: white; }
    .timeline-time { font-family: 'Consolas', monospace; font-size: 13px; min-width: 70px; text-align: center; }
    .speed-control { display: flex; align-items: center; gap: 8px; }
    .speed-label { font-size: 10px; color: #666; }
    .speed-value { font-family: 'Consolas', monospace; font-size: 12px; color: #ff6b35; min-width: 40px; }
    
    .help-panel { position: fixed; bottom: 16px; left: 16px; padding: 10px 16px; font-size: 10px; color: #666; display: flex; gap: 16px; z-index: 100; }
    .help-key { background: rgba(255,255,255,0.08); padding: 2px 6px; border-radius: 3px; font-family: 'Consolas', monospace; color: #aaa; margin-right: 4px; }
    
    .event-log { position: fixed; bottom: 70px; right: 16px; width: 260px; z-index: 100; }
    .event-item { background: rgba(10,10,18,0.95); border: 1px solid rgba(255,255,255,0.08); border-radius: 9px; padding: 10px 14px; margin-bottom: 7px; animation: slideIn 0.3s ease; display: flex; align-items: center; gap: 9px; font-size: 11px; }
    @keyframes slideIn { from { transform: translateX(80px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    .event-item.destruction { border-color: rgba(239,68,68,0.4); }
    .event-time { font-size: 9px; color: #666; margin-left: auto; }
    
    .loading { position: fixed; inset: 0; background: #05050a; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; transition: opacity 0.4s; }
    .loading.hidden { opacity: 0; pointer-events: none; }
    .loading-icon { width: 70px; height: 70px; border-radius: 50%; background: radial-gradient(circle at 30% 30%, #222, #000); box-shadow: 0 0 50px rgba(255,107,53,0.4); margin-bottom: 20px; animation: pulse 1.5s ease-in-out infinite; }
    @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
    .loading-text { font-size: 12px; color: #666; letter-spacing: 2px; text-transform: uppercase; }
</style>
```

</head>
<body>
    <div class="loading" id="loading">
        <div class="loading-icon"></div>
        <div class="loading-text">Simulation wird geladen...</div>
    </div>

```
<div class="canvas-container">
    <canvas id="bgCanvas"></canvas>
    <canvas id="mainCanvas"></canvas>
</div>

<div class="panel control-panel">
    <div class="panel-header">
        <div class="panel-icon"></div>
        <div>
            <div class="panel-title">Schwarzes Loch</div>
            <div class="panel-subtitle">Gravitationssimulation</div>
        </div>
    </div>
    
    <div class="section">
        <div class="section-title">Objekt platzieren</div>
        <div class="spawner-grid">
            <button class="spawn-btn earth active" data-type="earth"><div class="icon"></div><div class="label">Erde</div></button>
            <button class="spawn-btn mars" data-type="mars"><div class="icon"></div><div class="label">Mars</div></button>
            <button class="spawn-btn jupiter" data-type="jupiter"><div class="icon"></div><div class="label">Jupiter</div></button>
            <button class="spawn-btn star" data-type="star"><div class="icon"></div><div class="label">Stern</div></button>
            <button class="spawn-btn neutron" data-type="neutron"><div class="icon"></div><div class="label">Neutron</div></button>
            <button class="spawn-btn asteroid" data-type="asteroid"><div class="icon"></div><div class="label">Asteroid</div></button>
        </div>
        <p style="font-size:10px;color:#555;margin-top:10px;">Klicke + ziehe f√ºr Anfangsgeschwindigkeit</p>
    </div>
    
    <div class="section">
        <div class="section-title">Aktive Objekte (<span id="objectCount">0</span>)</div>
        <div class="objects-list" id="objectsList"></div>
        <div class="btn-group">
            <button class="btn btn-secondary" id="btnClearAll">Alle l√∂schen</button>
            <button class="btn btn-primary" id="btnAddRandom">+10 Zuf√§llig</button>
        </div>
    </div>
    
    <div class="section">
        <div class="section-title">Schwarzes Loch</div>
        <div class="control">
            <div class="control-label"><span>Masse</span><span class="control-value" id="bhMassVal">10 M‚òâ</span></div>
            <input type="range" id="bhMass" min="1" max="100" value="10">
        </div>
    </div>
    
    <div class="section">
        <div class="section-title">Visualisierung</div>
        <div class="toggle-row"><span>Akkretionsscheibe</span><label class="toggle"><input type="checkbox" id="showDisk" checked><span class="toggle-slider"></span></label></div>
        <div class="toggle-row"><span>Orbit-Spuren</span><label class="toggle"><input type="checkbox" id="showTrails" checked><span class="toggle-slider"></span></label></div>
        <div class="toggle-row"><span>ISCO anzeigen</span><label class="toggle"><input type="checkbox" id="showISCO" checked><span class="toggle-slider"></span></label></div>
        <div class="toggle-row"><span>Gezeitenkr√§fte</span><label class="toggle"><input type="checkbox" id="enableTidal" checked><span class="toggle-slider"></span></label></div>
        <div class="toggle-row"><span>Geschwindigkeitsvektor</span><label class="toggle"><input type="checkbox" id="showVelocity"><span class="toggle-slider"></span></label></div>
    </div>
    
    <div class="section">
        <div class="section-title">Kamera</div>
        <div class="control">
            <div class="control-label"><span>Zoom</span><span class="control-value" id="zoomVal">1.0x</span></div>
            <input type="range" id="cameraZoom" min="0.2" max="5" step="0.1" value="1">
        </div>
        <button class="btn btn-secondary" style="width:100%" id="btnResetCam">Kamera zur√ºcksetzen</button>
    </div>
</div>

<div class="panel info-panel">
    <div class="info-grid">
        <div class="info-item"><div class="info-label">Schwarzschild-R</div><div class="info-value" id="infoRs">29.5<span class="info-unit">km</span></div></div>
        <div class="info-item"><div class="info-label">ISCO</div><div class="info-value" id="infoISCO">6.0<span class="info-unit">r‚Çõ</span></div></div>
        <div class="info-item"><div class="info-label">Zeit</div><div class="info-value accent" id="infoTime">0.00<span class="info-unit">s</span></div></div>
        <div class="info-item"><div class="info-label">Verschluckt</div><div class="info-value" id="infoAccreted">0</div></div>
    </div>
    <div class="selected-detail" id="selectedDetail">
        <div class="selected-header">
            <div class="selected-icon" id="selectedIcon"></div>
            <div><div class="selected-name" id="selectedName">-</div><div class="selected-type" id="selectedType">-</div></div>
        </div>
        <div class="info-grid">
            <div class="info-item"><div class="info-label">Entfernung</div><div class="info-value" id="selDist">-</div></div>
            <div class="info-item"><div class="info-label">Geschwindigkeit</div><div class="info-value" id="selVel">-</div></div>
            <div class="info-item"><div class="info-label">Gezeitenkraft</div><div class="info-value" id="selTidal">-</div></div>
            <div class="info-item"><div class="info-label">Zeitdilatation</div><div class="info-value" id="selTimeDil">-</div></div>
        </div>
    </div>
</div>

<div class="event-log" id="eventLog"></div>

<div class="panel timeline-panel">
    <button class="timeline-btn" id="btnSlower">‚è™</button>
    <button class="timeline-btn" id="btnPlayPause">‚ñ∂</button>
    <button class="timeline-btn" id="btnFaster">‚è©</button>
    <div class="speed-control">
        <span class="speed-label">Speed:</span>
        <span class="speed-value" id="speedValue">1.0x</span>
    </div>
    <div class="timeline-time" id="timeDisplay">00:00.0</div>
</div>

<div class="panel help-panel">
    <div><span class="help-key">Klick</span>Platzieren</div>
    <div><span class="help-key">Drag</span>Geschwindigkeit</div>
    <div><span class="help-key">Scroll</span>Zoom</div>
    <div><span class="help-key">Space</span>Play/Pause</div>
</div>
```

<script>
const bgCanvas = document.getElementById('bgCanvas');
const mainCanvas = document.getElementById('mainCanvas');
const bgCtx = bgCanvas.getContext('2d');
const ctx = mainCanvas.getContext('2d');

// === OBJECT TYPES ===
const TYPES = {
    earth: { name: 'Erde', mass: 1, radius: 1, color: '#3b82f6', gradient: ['#3b82f6','#22c55e'], density: 5515 },
    mars: { name: 'Mars', mass: 0.107, radius: 0.532, color: '#dc2626', gradient: ['#dc2626','#ea580c'], density: 3933 },
    jupiter: { name: 'Jupiter', mass: 317.8, radius: 11.2, color: '#d97706', gradient: ['#d97706','#fbbf24'], density: 1326 },
    star: { name: 'Stern', mass: 332946, radius: 109, color: '#fbbf24', gradient: ['#fef3c7','#f59e0b'], density: 1408, glow: true },
    neutron: { name: 'Neutronenstern', mass: 465724, radius: 0.002, color: '#6366f1', gradient: ['#e0e7ff','#6366f1'], density: 4e17, glow: true },
    asteroid: { name: 'Asteroid', mass: 1e-10, radius: 0.00005, color: '#78716c', gradient: ['#57534e','#78716c'], density: 3000 }
};

// === STATE ===
const state = {
    blackHole: { mass: 10, x: 0, y: 0 },
    disk: { enabled: true, inner: 3, outer: 15 },
    show: { trails: true, isco: true, velocity: false, disk: true },
    enableTidal: true,
    camera: { x: 0, y: 0, zoom: 1 },
    time: 0, speed: 1, paused: true,
    objects: [], selectedObject: null, selectedType: 'earth',
    accretedCount: 0
};

let stars = [];

// === PHYSICS ===
function getRS(mass) { return 2.95 * mass; }
function getISCO(mass) { return 3 * getRS(mass); }
function getOrbitalVel(dist, mass) { return Math.sqrt(getRS(mass) / (2 * dist)); }
function getTidalForce(dist, objRadius, bhMass) {
    const rs = getRS(bhMass);
    if (dist < rs) return Infinity;
    return 2 * rs * objRadius / (dist * dist * dist);
}
function getTimeDilation(dist, bhMass) {
    const rs = getRS(bhMass);
    if (dist <= rs) return Infinity;
    return 1 / Math.sqrt(1 - rs / dist);
}

// === OBJECT CLASS ===
class SpaceObject {
    constructor(type, x, y, vx = 0, vy = 0) {
        this.id = Date.now() + Math.random();
        this.type = type;
        this.cfg = TYPES[type];
        this.x = x; this.y = y;
        this.vx = vx; this.vy = vy;
        this.mass = this.cfg.mass;
        this.radius = this.cfg.radius;
        this.trail = [];
        this.alive = true;
        this.stretched = 1;
        this.deathTime = null;
    }
    
    get dist() { return Math.sqrt(this.x * this.x + this.y * this.y); }
    get speed() { return Math.sqrt(this.vx * this.vx + this.vy * this.vy); }
    get displayR() { return Math.max(4, (Math.log10(this.radius + 1) * 8 + 5) * state.camera.zoom); }
    
    update(dt) {
        if (!this.alive) return;
        
        const rs = getRS(state.blackHole.mass);
        const dist = this.dist;
        
        // Event Horizon
        if (dist < rs * 1.01) { this.destroy('Ereignishorizont'); return; }
        
        // Tidal forces
        if (state.enableTidal) {
            const tidal = getTidalForce(dist, this.radius * 6371, state.blackHole.mass);
            this.stretched = 1 + tidal * 10;
            if (this.stretched > 3 && this.type !== 'neutron') {
                this.destroy('Gezeitenkr√§fte'); return;
            }
        }
        
        // Gravity
        const acc = rs / (2 * dist * dist);
        const dx = -this.x / dist, dy = -this.y / dist;
        
        this.vx += acc * dx * dt;
        this.vy += acc * dy * dt;
        this.x += this.vx * dt;
        this.y += this.vy * dt;
        
        // Trail
        this.trail.push({ x: this.x, y: this.y });
        if (this.trail.length > 200) this.trail.shift();
    }
    
    destroy(reason) {
        this.alive = false;
        this.deathTime = state.time;
        state.accretedCount++;
        addEvent(`${this.cfg.name} zerst√∂rt: ${reason}`);
    }
    
    draw() {
        const pos = worldToScreen(this.x, this.y);
        const r = this.displayR;
        
        // Trail
        if (state.show.trails && this.trail.length > 1) {
            ctx.beginPath();
            const s = worldToScreen(this.trail[0].x, this.trail[0].y);
            ctx.moveTo(s.x, s.y);
            for (let i = 1; i < this.trail.length; i++) {
                const p = worldToScreen(this.trail[i].x, this.trail[i].y);
                ctx.lineTo(p.x, p.y);
            }
            ctx.strokeStyle = this.cfg.color + '60';
            ctx.lineWidth = 1.5;
            ctx.stroke();
        }
        
        // Velocity vector
        if (state.show.velocity) {
            const vScale = 50 * state.camera.zoom;
            ctx.beginPath();
            ctx.moveTo(pos.x, pos.y);
            ctx.lineTo(pos.x + this.vx * vScale, pos.y + this.vy * vScale);
            ctx.strokeStyle = '#22c55e';
            ctx.lineWidth = 2;
            ctx.stroke();
        }
        
        // Glow
        if (this.cfg.glow) {
            const glow = ctx.createRadialGradient(pos.x, pos.y, 0, pos.x, pos.y, r * 3);
            glow.addColorStop(0, this.cfg.color + '50');
            glow.addColorStop(1, 'transparent');
            ctx.beginPath();
            ctx.arc(pos.x, pos.y, r * 3, 0, Math.PI * 2);
            ctx.fillStyle = glow;
            ctx.fill();
        }
        
        // Object
        ctx.save();
        ctx.translate(pos.x, pos.y);
        if (this.stretched > 1) {
            const angle = Math.atan2(this.y, this.x);
            ctx.rotate(angle);
            ctx.scale(this.stretched, 1 / Math.sqrt(this.stretched));
        }
        
        const grad = ctx.createRadialGradient(-r * 0.3, -r * 0.3, 0, 0, 0, r);
        grad.addColorStop(0, this.cfg.gradient[0]);
        grad.addColorStop(1, this.cfg.gradient[1] || this.cfg.gradient[0]);
        
        ctx.beginPath();
        ctx.arc(0, 0, r, 0, Math.PI * 2);
        ctx.fillStyle = grad;
        ctx.fill();
        
        ctx.beginPath();
        ctx.arc(-r * 0.25, -r * 0.25, r * 0.25, 0, Math.PI * 2);
        ctx.fillStyle = 'rgba(255,255,255,0.25)';
        ctx.fill();
        
        ctx.restore();
        
        // Selection
        if (state.selectedObject === this) {
            ctx.beginPath();
            ctx.arc(pos.x, pos.y, r + 5, 0, Math.PI * 2);
            ctx.strokeStyle = '#ff6b35';
            ctx.lineWidth = 2;
            ctx.setLineDash([4, 4]);
            ctx.stroke();
            ctx.setLineDash([]);
        }
    }
}

// === COORDINATES ===
function worldToScreen(wx, wy) {
    const s = 5 * state.camera.zoom;
    return {
        x: mainCanvas.width / 2 + (wx - state.camera.x) * s,
        y: mainCanvas.height / 2 + (wy - state.camera.y) * s
    };
}

function screenToWorld(sx, sy) {
    const s = 5 * state.camera.zoom;
    return {
        x: (sx - mainCanvas.width / 2) / s + state.camera.x,
        y: (sy - mainCanvas.height / 2) / s + state.camera.y
    };
}

// === RENDERING ===
function generateStars() {
    stars = [];
    for (let i = 0; i < 400; i++) {
        stars.push({
            x: Math.random() * 2000 - 1000,
            y: Math.random() * 2000 - 1000,
            size: Math.random() * 1.5 + 0.5,
            brightness: Math.random() * 0.7 + 0.3
        });
    }
}

function drawBackground() {
    bgCtx.fillStyle = '#05050a';
    bgCtx.fillRect(0, 0, bgCanvas.width, bgCanvas.height);
    
    stars.forEach(star => {
        const px = (star.x - state.camera.x * 0.1) % bgCanvas.width;
        const py = (star.y - state.camera.y * 0.1) % bgCanvas.height;
        const twinkle = 0.7 + 0.3 * Math.sin(state.time * 2 + star.x);
        
        bgCtx.beginPath();
        bgCtx.arc(px < 0 ? px + bgCanvas.width : px, py < 0 ? py + bgCanvas.height : py, star.size, 0, Math.PI * 2);
        bgCtx.fillStyle = `rgba(255,255,255,${star.brightness * twinkle})`;
        bgCtx.fill();
    });
}

function drawBlackHole() {
    const mass = state.blackHole.mass;
    const rs = getRS(mass);
    const isco = getISCO(mass);
    const center = worldToScreen(0, 0);
    const scale = 5 * state.camera.zoom;
    
    // Accretion disk
    if (state.show.disk) {
        ctx.save();
        ctx.translate(center.x, center.y);
        ctx.scale(1, 0.25);
        
        const innerR = state.disk.inner * rs * scale;
        const outerR = state.disk.outer * rs * scale;
        
        const diskGrad = ctx.createRadialGradient(0, 0, innerR, 0, 0, outerR);
        diskGrad.addColorStop(0, 'rgba(255,180,80,0.7)');
        diskGrad.addColorStop(0.3, 'rgba(255,120,40,0.4)');
        diskGrad.addColorStop(0.7, 'rgba(255,80,20,0.15)');
        diskGrad.addColorStop(1, 'transparent');
        
        ctx.beginPath();
        ctx.arc(0, 0, outerR, 0, Math.PI * 2);
        ctx.arc(0, 0, innerR, 0, Math.PI * 2, true);
        ctx.fillStyle = diskGrad;
        ctx.fill();
        ctx.restore();
    }
    
    // ISCO
    if (state.show.isco) {
        ctx.beginPath();
        ctx.arc(center.x, center.y, isco * scale, 0, Math.PI * 2);
        ctx.strokeStyle = 'rgba(74,222,128,0.35)';
        ctx.lineWidth = 1;
        ctx.setLineDash([5, 5]);
        ctx.stroke();
        ctx.setLineDash([]);
        
        ctx.fillStyle = 'rgba(74,222,128,0.5)';
        ctx.font = '9px sans-serif';
        ctx.fillText('ISCO', center.x + isco * scale + 4, center.y);
    }
    
    // Photon sphere
    ctx.beginPath();
    ctx.arc(center.x, center.y, rs * 1.5 * scale, 0, Math.PI * 2);
    ctx.strokeStyle = 'rgba(251,191,38,0.4)';
    ctx.lineWidth = 2;
    ctx.stroke();
    
    // Event horizon
    const bhGrad = ctx.createRadialGradient(center.x, center.y, 0, center.x, center.y, rs * scale * 1.3);
    bhGrad.addColorStop(0, '#000');
    bhGrad.addColorStop(0.8, '#000');
    bhGrad.addColorStop(0.9, 'rgba(30,15,0,0.8)');
    bhGrad.addColorStop(1, 'transparent');
    
    ctx.beginPath();
    ctx.arc(center.x, center.y, rs * scale * 1.3, 0, Math.PI * 2);
    ctx.fillStyle = bhGrad;
    ctx.fill();
}

function drawOrbitPreview(mouseWorld) {
    if (!mouseWorld) return;
    
    const rs = getRS(state.blackHole.mass);
    let x = mouseWorld.x, y = mouseWorld.y;
    const dist = Math.sqrt(x * x + y * y);
    const orbVel = getOrbitalVel(dist, state.blackHole.mass);
    let vx = -y / dist * orbVel;
    let vy = x / dist * orbVel;
    
    ctx.beginPath();
    const start = worldToScreen(x, y);
    ctx.moveTo(start.x, start.y);
    
    for (let i = 0; i < 400; i++) {
        const d = Math.sqrt(x * x + y * y);
        if (d < rs * 1.1 || d > 400) break;
        
        const acc = rs / (2 * d * d);
        vx += acc * (-x / d) * 0.05;
        vy += acc * (-y / d) * 0.05;
        x += vx * 0.05;
        y += vy * 0.05;
        
        const p = worldToScreen(x, y);
        ctx.lineTo(p.x, p.y);
    }
    
    ctx.strokeStyle = 'rgba(255,107,53,0.3)';
    ctx.lineWidth = 2;
    ctx.setLineDash([5, 5]);
    ctx.stroke();
    ctx.setLineDash([]);
}

// === EVENTS ===
function addEvent(message) {
    const log = document.getElementById('eventLog');
    const el = document.createElement('div');
    el.className = 'event-item destruction';
    el.innerHTML = `<span>üí•</span><span>${message}</span><span class="event-time">${state.time.toFixed(1)}s</span>`;
    log.appendChild(el);
    
    setTimeout(() => {
        el.style.opacity = '0';
        setTimeout(() => el.remove(), 300);
    }, 4000);
    
    while (log.children.length > 5) log.firstChild.remove();
}

// === UI UPDATES ===
function updateInfo() {
    const mass = state.blackHole.mass;
    const rs = getRS(mass);
    
    document.getElementById('infoRs').innerHTML = `${(rs * mass).toFixed(1)}<span class="info-unit">km</span>`;
    document.getElementById('infoISCO').innerHTML = `${(getISCO(mass) / rs).toFixed(1)}<span class="info-unit">r‚Çõ</span>`;
    document.getElementById('infoTime').innerHTML = `${state.time.toFixed(2)}<span class="info-unit">s</span>`;
    document.getElementById('infoAccreted').textContent = state.accretedCount;
    
    const detail = document.getElementById('selectedDetail');
    if (state.selectedObject && state.selectedObject.alive) {
        detail.classList.add('visible');
        const obj = state.selectedObject;
        
        document.getElementById('selectedIcon').style.background = `linear-gradient(135deg, ${obj.cfg.gradient.join(', ')})`;
        document.getElementById('selectedName').textContent = obj.cfg.name;
        document.getElementById('selectedType').textContent = `${obj.mass.toFixed(2)} M‚äï`;
        document.getElementById('selDist').textContent = `${(obj.dist / rs).toFixed(2)} r‚Çõ`;
        document.getElementById('selVel').textContent = `${(obj.speed * 1000).toFixed(0)} km/s`;
        
        const tidal = getTidalForce(obj.dist, obj.radius * 6371, mass);
        const tidalEl = document.getElementById('selTidal');
        tidalEl.textContent = `${(tidal * 1e6).toFixed(1)} Œºg`;
        tidalEl.className = 'info-value' + (tidal > 0.01 ? ' danger' : tidal > 0.001 ? ' warning' : '');
        
        document.getElementById('selTimeDil').textContent = `${getTimeDilation(obj.dist, mass).toFixed(3)}x`;
    } else {
        detail.classList.remove('visible');
    }
}

function updateObjectsList() {
    const list = document.getElementById('objectsList');
    const alive = state.objects.filter(o => o.alive);
    document.getElementById('objectCount').textContent = alive.length;
    
    list.innerHTML = alive.map(obj => {
        const rs = getRS(state.blackHole.mass);
        const isco = getISCO(state.blackHole.mass);
        let status = `${(obj.dist / rs).toFixed(1)} r‚Çõ`;
        let statusClass = '';
        
        if (obj.dist < isco) { status = 'Einfallend!'; statusClass = 'danger'; }
        else if (obj.stretched > 1.5) { status = 'Gestreckt!'; statusClass = 'warning'; }
        
        return `<div class="object-item ${state.selectedObject === obj ? 'selected' : ''}" data-id="${obj.id}">
            <div class="object-dot" style="background:${obj.cfg.color}"></div>
            <div class="object-info"><div class="object-name">${obj.cfg.name}</div><div class="object-status ${statusClass}">${status}</div></div>
            <button class="object-delete" data-id="${obj.id}">‚úï</button>
        </div>`;
    }).join('');
    
    list.querySelectorAll('.object-item').forEach(el => {
        el.addEventListener('click', e => {
            if (e.target.classList.contains('object-delete')) return;
            state.selectedObject = state.objects.find(o => o.id === parseFloat(el.dataset.id));
            updateObjectsList();
        });
    });
    
    list.querySelectorAll('.object-delete').forEach(btn => {
        btn.addEventListener('click', e => {
            e.stopPropagation();
            const obj = state.objects.find(o => o.id === parseFloat(btn.dataset.id));
            if (obj) { obj.destroy('Entfernt'); if (state.selectedObject === obj) state.selectedObject = null; }
            updateObjectsList();
        });
    });
}

// === INPUT ===
let spawnPreview = null, spawnStart = null, spawnVel = null;

mainCanvas.addEventListener('mousedown', e => {
    const rect = mainCanvas.getBoundingClientRect();
    const sx = e.clientX - rect.left, sy = e.clientY - rect.top;
    const world = screenToWorld(sx, sy);
    spawnPreview = world;
    spawnStart = { sx, sy, world };
});

mainCanvas.addEventListener('mousemove', e => {
    const rect = mainCanvas.getBoundingClientRect();
    const sx = e.clientX - rect.left, sy = e.clientY - rect.top;
    
    if (spawnStart) {
        const dx = sx - spawnStart.sx, dy = sy - spawnStart.sy;
        if (Math.abs(dx) > 5 || Math.abs(dy) > 5) {
            const scale = 5 * state.camera.zoom;
            spawnVel = { sx: dx, sy: dy, wx: dx / scale * 0.02, wy: dy / scale * 0.02 };
        } else spawnVel = null;
    } else {
        spawnPreview = screenToWorld(sx, sy);
    }
});

mainCanvas.addEventListener('mouseup', e => {
    if (!spawnStart) return;
    
    let vx = 0, vy = 0;
    if (spawnVel) {
        vx = spawnVel.wx; vy = spawnVel.wy;
    } else {
        const dist = Math.sqrt(spawnStart.world.x ** 2 + spawnStart.world.y ** 2);
        const orbVel = getOrbitalVel(dist, state.blackHole.mass);
        vx = -spawnStart.world.y / dist * orbVel;
        vy = spawnStart.world.x / dist * orbVel;
    }
    
    const obj = new SpaceObject(state.selectedType, spawnStart.world.x, spawnStart.world.y, vx, vy);
    state.objects.push(obj);
    state.selectedObject = obj;
    updateObjectsList();
    
    spawnStart = null; spawnVel = null;
});

mainCanvas.addEventListener('mouseleave', () => { spawnPreview = null; });

mainCanvas.addEventListener('wheel', e => {
    e.preventDefault();
    state.camera.zoom = Math.max(0.2, Math.min(5, state.camera.zoom * (e.deltaY > 0 ? 0.9 : 1.1)));
    document.getElementById('cameraZoom').value = state.camera.zoom;
    document.getElementById('zoomVal').textContent = state.camera.zoom.toFixed(1) + 'x';
}, { passive: false });

document.addEventListener('keydown', e => {
    if (e.code === 'Space') { e.preventDefault(); state.paused = !state.paused; updatePlayBtn(); }
});

// === CONTROLS ===
function bindControls() {
    document.querySelectorAll('.spawn-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.spawn-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            state.selectedType = btn.dataset.type;
        });
    });
    
    document.getElementById('bhMass').addEventListener('input', e => {
        state.blackHole.mass = parseFloat(e.target.value);
        document.getElementById('bhMassVal').textContent = state.blackHole.mass + ' M‚òâ';
    });
    
    document.getElementById('showDisk').addEventListener('change', e => state.show.disk = e.target.checked);
    document.getElementById('showTrails').addEventListener('change', e => state.show.trails = e.target.checked);
    document.getElementById('showISCO').addEventListener('change', e => state.show.isco = e.target.checked);
    document.getElementById('enableTidal').addEventListener('change', e => state.enableTidal = e.target.checked);
    document.getElementById('showVelocity').addEventListener('change', e => state.show.velocity = e.target.checked);
    
    document.getElementById('cameraZoom').addEventListener('input', e => {
        state.camera.zoom = parseFloat(e.target.value);
        document.getElementById('zoomVal').textContent = state.camera.zoom.toFixed(1) + 'x';
    });
    
    document.getElementById('btnResetCam').addEventListener('click', () => {
        state.camera = { x: 0, y: 0, zoom: 1 };
        document.getElementById('cameraZoom').value = 1;
        document.getElementById('zoomVal').textContent = '1.0x';
    });
    
    document.getElementById('btnPlayPause').addEventListener('click', () => { state.paused = !state.paused; updatePlayBtn(); });
    document.getElementById('btnSlower').addEventListener('click', () => { state.speed = Math.max(0.1, state.speed / 2); updateSpeed(); });
    document.getElementById('btnFaster').addEventListener('click', () => { state.speed = Math.min(10, state.speed * 2); updateSpeed(); });
    
    document.getElementById('btnClearAll').addEventListener('click', () => {
        state.objects.forEach(o => o.alive = false);
        state.objects = [];
        state.selectedObject = null;
        updateObjectsList();
    });
    
    document.getElementById('btnAddRandom').addEventListener('click', () => {
        const types = ['earth', 'mars', 'jupiter', 'asteroid', 'asteroid', 'asteroid'];
        const rs = getRS(state.blackHole.mass);
        
        for (let i = 0; i < 10; i++) {
            const type = types[Math.floor(Math.random() * types.length)];
            const angle = Math.random() * Math.PI * 2;
            const dist = rs * (5 + Math.random() * 20);
            const x = Math.cos(angle) * dist, y = Math.sin(angle) * dist;
            const orbVel = getOrbitalVel(dist, state.blackHole.mass) * (0.8 + Math.random() * 0.4);
            state.objects.push(new SpaceObject(type, x, y, -y / dist * orbVel, x / dist * orbVel));
        }
        updateObjectsList();
    });
}

function updatePlayBtn() {
    document.getElementById('btnPlayPause').textContent = state.paused ? '‚ñ∂' : '‚è∏';
    document.getElementById('btnPlayPause').classList.toggle('active', !state.paused);
}

function updateSpeed() {
    document.getElementById('speedValue').textContent = state.speed.toFixed(1) + 'x';
}

// === MAIN LOOP ===
function resize() {
    const dpr = window.devicePixelRatio || 1;
    [bgCanvas, mainCanvas].forEach(c => {
        c.width = window.innerWidth * dpr;
        c.height = window.innerHeight * dpr;
        c.style.width = window.innerWidth + 'px';
        c.style.height = window.innerHeight + 'px';
        c.getContext('2d').scale(dpr, dpr);
    });
}

function simulate(dt) {
    for (let i = 0; i < 4; i++) {
        state.objects.forEach(obj => obj.update(dt / 4));
    }
    state.objects = state.objects.filter(o => o.alive || (state.time - o.deathTime < 1));
}

function render() {
    ctx.clearRect(0, 0, mainCanvas.width, mainCanvas.height);
    drawBackground();
    
    if (spawnPreview && !spawnStart) drawOrbitPreview(spawnPreview);
    
    drawBlackHole();
    state.objects.forEach(obj => { if (obj.alive) obj.draw(); });
    
    // Spawn preview
    if (spawnStart) {
        const pos = worldToScreen(spawnStart.world.x, spawnStart.world.y);
        ctx.beginPath();
        ctx.arc(pos.x, pos.y, 12, 0, Math.PI * 2);
        ctx.fillStyle = TYPES[state.selectedType].color + '50';
        ctx.fill();
        ctx.strokeStyle = TYPES[state.selectedType].color;
        ctx.lineWidth = 2;
        ctx.stroke();
        
        if (spawnVel) {
            ctx.beginPath();
            ctx.moveTo(pos.x, pos.y);
            ctx.lineTo(pos.x + spawnVel.sx, pos.y + spawnVel.sy);
            ctx.strokeStyle = '#22c55e';
            ctx.lineWidth = 3;
            ctx.stroke();
        }
    }
}

function gameLoop(ts) {
    if (!state.paused) {
        const dt = 0.01 * state.speed;
        simulate(dt);
        state.time += dt;
    }
    
    render();
    updateInfo();
    document.getElementById('timeDisplay').textContent = 
        `${Math.floor(state.time / 60).toString().padStart(2, '0')}:${(state.time % 60).toFixed(1).padStart(4, '0')}`;
    
    requestAnimationFrame(gameLoop);
}

// === INIT ===
function init() {
    resize();
    generateStars();
    bindControls();
    updatePlayBtn();
    updateSpeed();
    
    // Demo objects
    const rs = getRS(state.blackHole.mass);
    [
        { type: 'earth', dist: 12, angle: 0 },
        { type: 'mars', dist: 18, angle: Math.PI / 3 },
        { type: 'jupiter', dist: 25, angle: Math.PI }
    ].forEach(d => {
        const x = Math.cos(d.angle) * d.dist * rs;
        const y = Math.sin(d.angle) * d.dist * rs;
        const v = getOrbitalVel(d.dist * rs, state.blackHole.mass);
        state.objects.push(new SpaceObject(d.type, x, y, -y / (d.dist * rs) * v, x / (d.dist * rs) * v));
    });
    updateObjectsList();
    
    window.addEventListener('resize', resize);
    
    setTimeout(() => document.getElementById('loading').classList.add('hidden'), 500);
    requestAnimationFrame(gameLoop);
}

init();
</script>

</body>
</html>