<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#000000">
<title>Darios Gym</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none;-webkit-user-select:none;user-select:none}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",system-ui,sans-serif;background:#000;color:#fff;padding:0;margin:0;overscroll-behavior:none;min-height:100vh}
.app{min-height:100vh;display:flex;flex-direction:column;background:#000}

/* Header */
.header{background:linear-gradient(135deg,#007AFF,#0051D5);padding:14px 16px;padding-top:calc(14px + env(safe-area-inset-top));position:fixed;top:0;left:0;right:0;z-index:100;box-shadow:0 1px 10px rgba(0,0,0,0.3)}
.header-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.header h1{font-size:26px;font-weight:700;letter-spacing:-0.5px}
.settings-btn{width:38px;height:38px;background:rgba(255,255,255,0.2);border:none;border-radius:10px;color:#fff;font-size:18px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all 0.2s;backdrop-filter:blur(10px)}
.settings-btn:active{transform:scale(0.9);background:rgba(255,255,255,0.3)}

/* Navigation */
.nav{display:flex;gap:6px;align-items:center}
.nav-btn{background:rgba(255,255,255,0.15);backdrop-filter:blur(10px);border:none;color:#fff;padding:10px;border-radius:10px;font-size:18px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;min-width:44px;min-height:44px;transition:all 0.2s}
.nav-btn:active{background:rgba(255,255,255,0.25);transform:scale(0.95)}
.date-btn{flex:1;text-align:center;font-size:15px;font-weight:600;padding:10px 16px;position:relative}
.date-input{position:absolute;top:0;left:0;width:100%;height:100%;opacity:0;cursor:pointer}

/* Content */
.content{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:16px;padding-top:calc(140px + env(safe-area-inset-top));padding-bottom:30px;background:#000}

/* Cards & Exercises */
.exercise{background:#1c1c1e;border-radius:14px;padding:12px;margin-bottom:12px;border:1px solid #2c2c2e}
.exercise-header{display:flex;align-items:center;margin-bottom:12px;gap:6px}
.exercise-name{font-size:17px;font-weight:600;flex:1}
.muscle-tag{background:#007AFF;padding:4px 10px;border-radius:16px;font-size:11px;font-weight:600;white-space:nowrap}
.delete-btn{background:#FF3B30;border:none;color:#fff;width:36px;height:36px;border-radius:10px;font-size:18px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all 0.2s}
.delete-btn:active{transform:scale(0.9)}

/* Sets */
.set{display:grid;grid-template-columns:38px 1fr 72px 46px;gap:6px;align-items:center;padding:8px;background:#2c2c2e;border-radius:10px;margin-bottom:6px;transition:all 0.2s}
.set.done{background:rgba(52,199,89,0.15);border:1px solid rgba(52,199,89,0.3)}
.set-num{width:38px;height:38px;background:#007AFF;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:600;font-size:15px}
.set.done .set-num{background:#34C759}
.input{background:#1c1c1e;border:1px solid #3a3a3c;border-radius:8px;padding:9px;color:#fff;font-size:16px;font-weight:500;text-align:center;width:100%;-webkit-appearance:none;transition:all 0.2s}
.input:focus{border-color:#007AFF;outline:none}
.check-btn{width:46px;height:40px;border-radius:10px;background:#2c2c2e;border:2px solid #3a3a3c;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:22px;transition:all 0.2s}
.check-btn.checked{background:#34C759;border-color:#34C759;color:#fff}

/* Empty State */
.empty{text-align:center;padding:60px 20px;color:#8E8E93}
.empty-icon{font-size:48px;margin-bottom:16px;opacity:0.5}
.empty-text{font-size:18px;font-weight:600;margin-bottom:8px}
.empty small{display:block;margin-top:4px;font-size:14px;opacity:0.7}

/* Buttons */
.add-btn{width:100%;padding:15px;background:#007AFF;border:none;border-radius:12px;color:#fff;font-size:16px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;margin-top:16px;transition:all 0.2s}
.add-btn:active{transform:scale(0.98);background:#0051D5}
.template-btn{background:#5E5CE6;margin-top:8px}
.template-btn:active{background:#4B47D5}

/* Modal */
.modal{position:fixed;inset:0;background:rgba(0,0,0,0.9);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);z-index:999;display:none;align-items:flex-end;padding:0}
.modal.open{display:flex}
.modal-content{background:#1c1c1e;border-radius:20px 20px 0 0;padding:20px;width:100%;max-height:85vh;overflow-y:auto;-webkit-overflow-scrolling:touch;padding-bottom:calc(20px + env(safe-area-inset-bottom));animation:slideUp 0.3s}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
.modal h3{font-size:22px;font-weight:700}
.close-modal{width:30px;height:30px;background:#3a3a3c;border:none;border-radius:50%;color:#fff;font-size:16px;display:flex;align-items:center;justify-content:center;cursor:pointer}
.form-group{margin-bottom:18px}
.label{display:block;margin-bottom:6px;font-size:12px;font-weight:600;color:#8E8E93;text-transform:uppercase;letter-spacing:0.5px}
input[type="text"],input[type="number"],input[type="password"],select{width:100%;padding:12px;background:#2c2c2e;border:1px solid #3a3a3c;border-radius:10px;color:#fff;font-size:16px;font-weight:400;-webkit-appearance:none;transition:all 0.2s}
input:focus,select:focus{border-color:#007AFF;outline:none}
select{cursor:pointer;background-image:url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%238E8E93' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");background-repeat:no-repeat;background-position:right 10px center;background-size:18px;padding-right:36px}
.modal-btn{width:100%;padding:14px;border:none;border-radius:10px;font-size:16px;font-weight:600;cursor:pointer;margin-bottom:8px;transition:all 0.2s}
.modal-btn.primary{background:#007AFF;color:#fff}
.modal-btn.secondary{background:#3a3a3c;color:#fff}
.modal-btn.danger{background:#FF3B30;color:#fff}
.modal-btn.success{background:#34C759;color:#fff}
.modal-btn.purple{background:#5E5CE6;color:#fff}
.modal-btn:active{transform:scale(0.98)}

/* Settings Items */
.settings-section{margin-bottom:20px}
.settings-title{font-size:12px;font-weight:600;color:#8E8E93;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:10px;padding-left:4px}
.settings-item{background:#2c2c2e;border-radius:10px;padding:14px;margin-bottom:8px;display:flex;align-items:center;gap:10px;cursor:pointer;transition:all 0.2s}
.settings-item:active{background:#3a3a3c}
.settings-icon{width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:18px}
.settings-icon.export{background:#5E5CE6}
.settings-icon.import{background:#FF9500}
.settings-icon.github{background:#34C759}
.settings-icon.templates{background:#FF2D55}
.settings-info{flex:1}
.settings-name{font-size:15px;font-weight:600;margin-bottom:2px}
.settings-desc{font-size:12px;color:#8E8E93}
.settings-arrow{color:#3a3a3c;font-size:16px}

/* Template List */
.template-list{margin-top:16px}
.template-item{background:#2c2c2e;border-radius:10px;padding:12px;margin-bottom:8px;display:flex;align-items:center;gap:10px}
.template-icon{width:40px;height:40px;background:#007AFF;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:20px}
.template-icon.day{background:#5E5CE6}
.template-info{flex:1}
.template-name{font-size:15px;font-weight:600}
.template-details{font-size:12px;color:#8E8E93;margin-top:2px}
.template-actions{display:flex;gap:6px}
.template-btn{width:36px;height:36px;border:none;border-radius:8px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:16px;transition:all 0.2s}
.template-btn.edit{background:#007AFF;color:#fff}
.template-btn.delete{background:#FF3B30;color:#fff}
.template-btn.use{background:#34C759;color:#fff}
.template-btn:active{transform:scale(0.9)}

/* Tabs */
.tabs{display:flex;gap:8px;margin-bottom:16px}
.tab{flex:1;padding:10px;background:#2c2c2e;border:1px solid #3a3a3c;border-radius:10px;text-align:center;font-size:14px;font-weight:600;cursor:pointer;transition:all 0.2s}
.tab.active{background:#007AFF;border-color:#007AFF;color:#fff}

/* Choice Grid */
.choice-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px}
.choice-card{background:#2c2c2e;border:2px solid #3a3a3c;border-radius:12px;padding:20px;text-align:center;cursor:pointer;transition:all 0.2s}
.choice-card:active{transform:scale(0.95);background:#3a3a3c}
.choice-icon{font-size:36px;margin-bottom:8px}
.choice-title{font-size:16px;font-weight:600;margin-bottom:4px}
.choice-desc{font-size:12px;color:#8E8E93}

/* Toast Notification */
.toast{position:fixed;top:calc(20px + env(safe-area-inset-top));left:50%;transform:translateX(-50%);background:#34C759;color:#fff;padding:12px 20px;border-radius:12px;font-size:15px;font-weight:600;z-index:10000;animation:toastIn 0.3s,toastOut 0.5s 2s forwards;box-shadow:0 4px 12px rgba(0,0,0,0.3)}
@keyframes toastIn{from{transform:translateX(-50%) translateY(-100%);opacity:0}to{transform:translateX(-50%) translateY(0);opacity:1}}
@keyframes toastOut{from{transform:translateX(-50%) translateY(0);opacity:1}to{transform:translateX(-50%) translateY(-20px);opacity:0}}

/* Responsive */
@media (max-width:375px){
.header h1{font-size:24px}
.set{grid-template-columns:36px 1fr 65px 44px;gap:6px}
.input{font-size:15px;padding:8px}
}
</style>
</head>
<body>
<div class="app">
<div class="header">
<div class="header-top">
<h1>üí™ Darios Gym</h1>
<button class="settings-btn" onclick="openSettings()">‚öôÔ∏è</button>
</div>
<div class="nav">
<button class="nav-btn" onclick="cd(-1)">‚Üê</button>
<div class="nav-btn date-btn" id="dd">
<span id="date-text"></span>
<input type="date" class="date-input" id="di" onchange="sd(this.value)">
</div>
<button class="nav-btn" onclick="cd(1)">‚Üí</button>
</div>
</div>

<div class="content" id="ex"></div>
</div>

<!-- Add Exercise Modal -->
<div class="modal" id="am">
<div class="modal-content">
<div class="modal-header">
<h3>Hinzuf√ºgen</h3>
<button class="close-modal" onclick="cm('am')">√ó</button>
</div>
<div class="choice-grid">
<div class="choice-card" onclick="showManualAdd()">
<div class="choice-icon">‚úèÔ∏è</div>
<div class="choice-title">Neue √úbung</div>
<div class="choice-desc">Manuell erstellen</div>
</div>
<div class="choice-card" onclick="showTemplateSelect()">
<div class="choice-icon">üí™</div>
<div class="choice-title">√úbungs-Template</div>
<div class="choice-desc">Aus Vorlage w√§hlen</div>
</div>
</div>
<div id="day-template-option"></div>
</div>
</div>

<!-- Manual Add Form -->
<div class="modal" id="mam">
<div class="modal-content">
<div class="modal-header">
<h3>Neue √úbung</h3>
<button class="close-modal" onclick="cm('mam')">√ó</button>
</div>
<div class="form-group">
<label class="label">Name</label>
<input type="text" id="nn" placeholder="z.B. Bankdr√ºcken" autocomplete="off">
</div>
<div class="form-group">
<label class="label">S√§tze</label>
<input type="number" id="ns" value="3" min="1" max="10" inputmode="numeric">
</div>
<div class="form-group">
<label class="label">Wiederholungen</label>
<input type="text" id="nr" value="8-12" placeholder="8-12" autocomplete="off">
</div>
<div class="form-group">
<label class="label">Typ</label>
<select id="nt">
<option value="kg">Gewicht (kg)</option>
<option value="m">Distanz (m)</option>
<option value="min">Zeit (min)</option>
</select>
</div>
<div class="form-group">
<label class="label">Muskelgruppe</label>
<select id="nm">
<option value="Brust">Brust</option>
<option value="R√ºcken">R√ºcken</option>
<option value="Beine">Beine</option>
<option value="Schultern">Schultern</option>
<option value="Arme">Arme</option>
<option value="Bauch">Bauch</option>
<option value="Cardio">Cardio</option>
<option value="Andere">Andere</option>
</select>
</div>
<button class="modal-btn primary" onclick="ae()">√úbung hinzuf√ºgen</button>
<button class="modal-btn purple" onclick="saveAsTemplate()">Als Template speichern</button>
<button class="modal-btn secondary" onclick="cm('mam')">Abbrechen</button>
</div>
</div>

<!-- Template Select Modal -->
<div class="modal" id="tsm">
<div class="modal-content">
<div class="modal-header">
<h3>Template w√§hlen</h3>
<button class="close-modal" onclick="cm('tsm')">√ó</button>
</div>
<div id="template-select-list"></div>
<button class="modal-btn secondary" onclick="cm('tsm');$('am').classList.add('open')">Zur√ºck</button>
</div>
</div>

<!-- Settings Modal -->
<div class="modal" id="sm">
<div class="modal-content">
<div class="modal-header">
<h3>Einstellungen</h3>
<button class="close-modal" onclick="cm('sm')">√ó</button>
</div>
<div class="settings-section">
<div class="settings-title">Templates</div>
<div class="settings-item" onclick="openTemplates()">
<div class="settings-icon templates">üìù</div>
<div class="settings-info">
<div class="settings-name">Templates verwalten</div>
<div class="settings-desc">√úbungen und Tagespl√§ne bearbeiten</div>
</div>
<div class="settings-arrow">‚Ä∫</div>
</div>
</div>
<div class="settings-section">
<div class="settings-title">Daten</div>
<div class="settings-item" onclick="xp()">
<div class="settings-icon export">üì§</div>
<div class="settings-info">
<div class="settings-name">Export</div>
<div class="settings-desc">Trainingsdaten als JSON exportieren</div>
</div>
<div class="settings-arrow">‚Ä∫</div>
</div>
<div class="settings-item" onclick="im()">
<div class="settings-icon import">üì•</div>
<div class="settings-info">
<div class="settings-name">Import</div>
<div class="settings-desc">Trainingsdaten aus JSON importieren</div>
</div>
<div class="settings-arrow">‚Ä∫</div>
</div>
</div>
<div class="settings-section">
<div class="settings-title">Synchronisation</div>
<div class="settings-item" onclick="cs()">
<div class="settings-icon github">‚òÅÔ∏è</div>
<div class="settings-info">
<div class="settings-name">GitHub Sync</div>
<div class="settings-desc" id="github-status">Automatische Synchronisation einrichten</div>
</div>
<div class="settings-arrow">‚Ä∫</div>
</div>
</div>
</div>
</div>

<!-- Templates Modal -->
<div class="modal" id="tm">
<div class="modal-content">
<div class="modal-header">
<h3>Templates</h3>
<button class="close-modal" onclick="cm('tm')">√ó</button>
</div>
<div class="tabs">
<div class="tab active" id="tab-ex" onclick="switchTab('ex')">√úbungen</div>
<div class="tab" id="tab-day" onclick="switchTab('day')">Tagespl√§ne</div>
</div>
<div id="template-list"></div>
<button class="modal-btn primary" id="add-template-btn" onclick="openAddTemplate()">‚ûï √úbungs-Template</button>
<button class="modal-btn secondary" onclick="cm('tm')">Schlie√üen</button>
</div>
</div>

<script>
const $=id=>document.getElementById(id);
let dt=new Date().toISOString().split('T')[0];
let w={};
let et=[];  // Exercise templates
let dts=[];  // Day templates
let currentTab='ex';
let editingTemplate=null;

// Load/Save
function l(){
try{
const data=JSON.parse(localStorage.getItem('w'))||{};
w=data.w||data||{};
et=data.et||[];
dts=data.dts||[];
}catch{w={};et=[];dts=[];}
}

function s(){
const data={w,et,dts,d:new Date()};
localStorage.setItem('w',JSON.stringify(data));
if(localStorage.getItem('ght'))ghs();
}

// Date
function fd(){
const d=new Date(dt+'T12:00');
const mo=['So','Mo','Di','Mi','Do','Fr','Sa'][d.getDay()];
$('date-text').textContent=`${mo}, ${d.getDate()}.${(d.getMonth()+1+'').padStart(2,'0')}.${d.getFullYear()}`;
$('di').value=dt;
}

function cd(n){
const d=new Date(dt+'T12:00');
d.setDate(d.getDate()+n);
dt=d.toISOString().split('T')[0];
fd();r();
}

function sd(v){dt=v;fd();r()}

// Render
function r(){
const k=dt;
const d=w[k];
let h='';
if(!d||!d.e||d.e.length===0){
h=`<div class="empty">
<div class="empty-icon">üèãÔ∏è‚Äç‚ôÇÔ∏è</div>
<div class="empty-text">Noch keine √úbungen</div>
<small>Starte dein Training mit dem Button unten</small>
</div>`;
}else{
d.e.forEach((x,i)=>{
const tp=x.t||'kg';
const ph=tp==='m'?'Meter':tp==='min'?'Min':'kg';
const ph2=tp==='kg'?'Wdh':'Zeit';
h+=`<div class="exercise">
<div class="exercise-header">
<div class="exercise-name">${x.n}</div>
<div class="muscle-tag">${x.m||'Andere'}</div>
<button class="edit-btn" onclick="editExercise(${i})" style="background:#007AFF;border:none;color:#fff;width:36px;height:36px;border-radius:10px;font-size:18px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all 0.2s">‚úèÔ∏è</button>
<button class="delete-btn" onclick="if(confirm('√úbung wirklich l√∂schen?'))re(${i})">√ó</button>
</div>`;
x.s.forEach((s,j)=>{
h+=`<div class="set ${s.d?'done':''}">
<div class="set-num">${j+1}</div>
<input class="input" placeholder="${ph}" value="${s.w||''}" onchange="us(${i},${j},'w',this.value)" inputmode="${tp==='kg'?'decimal':'numeric'}">
<input class="input" placeholder="${ph2}" value="${s.r||''}" onchange="us(${i},${j},'r',this.value)" inputmode="numeric">
<button class="check-btn ${s.d?'checked':''}" onclick="tg(${i},${j})">${s.d?'‚úì':''}</button>
</div>`;
});
h+=`</div>`;
});
}
h+=`<button class="add-btn" onclick="openAddModal()">‚ûï Neue √úbung</button>`;
$('ex').innerHTML=h;
}

// Update Set
function us(i,j,f,v){
const k=dt;
if(!w[k])w[k]={e:[]};
if(w[k].e[i]&&w[k].e[i].s[j]){
w[k].e[i].s[j][f]=v;
s();
}
}

// Toggle Done
function tg(i,j){
const k=dt;
if(w[k]&&w[k].e[i]&&w[k].e[i].s[j]){
w[k].e[i].s[j].d=!w[k].e[i].s[j].d;
s();r();
}
}

// Toast notification
function showToast(msg){
const t=document.createElement('div');
t.className='toast';
t.textContent=msg;
document.body.appendChild(t);
setTimeout(()=>t.remove(),2500);
}

// Add Exercise
function ae(){
const n=$('nn').value.trim();
const st=parseInt($('ns').value)||3;
const rp=$('nr').value||'8-12';
const tp=$('nt').value||'kg';
const mg=$('nm').value||'Andere';
if(n){
const k=dt;
if(!w[k])w[k]={e:[]};
w[k].e.push({n,r:rp,t:tp,m:mg,s:Array(st).fill().map(()=>({w:'',r:'',d:0}))});
$('nn').value='';$('ns').value='3';$('nr').value='8-12';$('nt').value='kg';$('nm').value='Brust';
cm('mam');cm('am');s();r();
}
}

// Edit Exercise
function editExercise(i){
const k=dt;
if(!w[k]||!w[k].e||!w[k].e[i])return;
const ex=w[k].e[i];
const m=document.createElement('div');
m.className='modal open';
m.onclick=e=>{if(e.target===m)m.remove()};
m.innerHTML=`<div class="modal-content">
<div class="modal-header">
<h3>√úbung bearbeiten</h3>
<button class="close-modal" onclick="this.parentElement.parentElement.parentElement.remove()">√ó</button>
</div>
<div class="form-group">
<label class="label">Name</label>
<input type="text" id="edit-name" value="${ex.n}" autocomplete="off">
</div>
<div class="form-group">
<label class="label">S√§tze</label>
<div style="display:flex;gap:10px;align-items:center">
<button onclick="adjustSets(-1)" style="width:40px;height:40px;background:#FF3B30;border:none;border-radius:10px;color:#fff;font-size:20px;cursor:pointer">‚àí</button>
<input type="number" id="edit-sets" value="${ex.s.length}" min="1" max="10" inputmode="numeric" style="text-align:center">
<button onclick="adjustSets(1)" style="width:40px;height:40px;background:#34C759;border:none;border-radius:10px;color:#fff;font-size:20px;cursor:pointer">+</button>
</div>
</div>
<div class="form-group">
<label class="label">Wiederholungen</label>
<input type="text" id="edit-reps" value="${ex.r||'8-12'}" placeholder="8-12" autocomplete="off">
</div>
<div class="form-group">
<label class="label">Typ</label>
<select id="edit-type">
<option value="kg" ${ex.t==='kg'?'selected':''}>Gewicht (kg)</option>
<option value="m" ${ex.t==='m'?'selected':''}>Distanz (m)</option>
<option value="min" ${ex.t==='min'?'selected':''}>Zeit (min)</option>
</select>
</div>
<div class="form-group">
<label class="label">Muskelgruppe</label>
<select id="edit-muscle">
${['Brust','R√ºcken','Beine','Schultern','Arme','Bauch','Cardio','Andere'].map(m=>`<option value="${m}" ${ex.m===m?'selected':''}>${m}</option>`).join('')}
</select>
</div>
<button class="modal-btn primary" onclick="saveExerciseEdit(${i})">Speichern</button>
<button class="modal-btn secondary" onclick="this.parentElement.parentElement.remove()">Abbrechen</button>
</div>`;
document.body.appendChild(m);
window.currentExerciseIndex=i;
window.currentSets=ex.s.length;
}

function adjustSets(delta){
const input=$('edit-sets');
let val=parseInt(input.value)||1;
val=Math.max(1,Math.min(10,val+delta));
input.value=val;
window.currentSets=val;
}

function saveExerciseEdit(i){
const k=dt;
if(!w[k]||!w[k].e||!w[k].e[i])return;
const name=$('edit-name').value.trim();
const sets=parseInt($('edit-sets').value)||3;
const reps=$('edit-reps').value||'8-12';
const type=$('edit-type').value||'kg';
const muscle=$('edit-muscle').value||'Andere';
if(name){
const ex=w[k].e[i];
ex.n=name;
ex.r=reps;
ex.t=type;
ex.m=muscle;
// Adjust sets array
const currentSetsCount=ex.s.length;
if(sets>currentSetsCount){
// Add new sets
for(let j=currentSetsCount;j<sets;j++){
ex.s.push({w:'',r:'',d:0});
}
}else if(sets<currentSetsCount){
// Remove sets (ask for confirmation if they have data)
const removedSets=ex.s.slice(sets);
const hasData=removedSets.some(s=>s.w||s.r);
if(hasData&&!confirm('Die letzten S√§tze haben Daten. Wirklich l√∂schen?')){
return;
}
ex.s=ex.s.slice(0,sets);
}
s();r();
showToast('‚úÖ √úbung aktualisiert');
document.querySelector('.modal.open').remove();
}
}

// Remove Exercise
function re(i){
const k=dt;
if(w[k]&&w[k].e){
w[k].e.splice(i,1);
if(w[k].e.length===0)delete w[k];
s();r();
}
}

// Open Add Modal with day template option if available
function openAddModal(){
// Check if day templates exist and add them to the modal
const dayOption = $('day-template-option');
if(dts.length>0){
let h='<div style="margin-top:10px"><div style="font-size:12px;color:#8E8E93;margin-bottom:8px;text-align:center">ODER</div>';
h+='<div class="choice-card" onclick="showDayTemplates()" style="width:100%">';
h+='<div class="choice-icon">üìÖ</div>';
h+='<div class="choice-title">Tagesplan laden</div>';
h+='<div class="choice-desc">Kompletten Trainingsplan</div>';
h+='</div></div>';
dayOption.innerHTML=h;
}else{
dayOption.innerHTML='';
}
$('am').classList.add('open');
}

// Template Functions
function showManualAdd(){
cm('am');
$('mam').classList.add('open');
}

function showTemplateSelect(){
cm('am');
renderTemplateSelect();
$('tsm').classList.add('open');
}

function renderTemplateSelect(){
let h='';
if(et.length===0){
h='<div class="empty"><div class="empty-text">Keine Templates vorhanden</div><small>Erstelle Templates in den Einstellungen</small></div>';
}else{
et.forEach((t,i)=>{
h+=`<div class="template-item">
<div class="template-icon">üí™</div>
<div class="template-info">
<div class="template-name">${t.n}</div>
<div class="template-details">${t.s} S√§tze √ó ${t.r} ‚Ä¢ ${t.m}</div>
</div>
<button class="template-btn use" onclick="useExerciseTemplate(${i})">‚Üí</button>
</div>`;
});
}
$('template-select-list').innerHTML=h;
}

function useExerciseTemplate(i){
const t=et[i];
if(t){
const k=dt;
if(!w[k])w[k]={e:[]};
w[k].e.push({
n:t.n,
r:t.r,
t:t.t||'kg',
m:t.m,
s:Array(t.s).fill().map(()=>({w:'',r:'',d:0}))
});
cm('tsm');s();r();
}
}

function showDayTemplates(){
cm('am'); // Close the add modal if open
let h='<div class="modal open" onclick="if(event.target===this)this.remove()"><div class="modal-content">';
h+='<div class="modal-header"><h3>Tagesplan w√§hlen</h3><button class="close-modal" onclick="this.parentElement.parentElement.parentElement.remove()">√ó</button></div>';
if(dts.length===0){
h+='<div class="empty"><div class="empty-text">Keine Tagespl√§ne vorhanden</div></div>';
}else{
dts.forEach((t,i)=>{
const exCount=t.exercises?t.exercises.length:0;
h+=`<div class="template-item">
<div class="template-icon day">üìÖ</div>
<div class="template-info">
<div class="template-name">${t.n}</div>
<div class="template-details">${exCount} √úbungen</div>
</div>
<button class="template-btn use" onclick="useDayTemplate(${i});this.parentElement.parentElement.parentElement.remove()">‚Üí</button>
</div>`;
});
}
h+='<button class="modal-btn secondary" onclick="this.parentElement.parentElement.remove()">Abbrechen</button>';
h+='</div></div>';
document.body.insertAdjacentHTML('beforeend',h);
}

function useDayTemplate(i){
const t=dts[i];
if(t&&t.exercises){
const k=dt;
if(!w[k])w[k]={e:[]};
t.exercises.forEach(ex=>{
w[k].e.push({
n:ex.n,
r:ex.r,
t:ex.t||'kg',
m:ex.m,
s:Array(ex.s).fill().map(()=>({w:'',r:'',d:0}))
});
});
s();r();
}
}

function saveAsTemplate(){
const n=$('nn').value.trim();
const st=parseInt($('ns').value)||3;
const rp=$('nr').value||'8-12';
const tp=$('nt').value||'kg';
const mg=$('nm').value||'Andere';
if(n){
et.push({n,s:st,r:rp,t:tp,m:mg});
s();
showToast('‚úÖ Als Template gespeichert!');
}
}

// Templates Management
function openTemplates(){
cm('sm');
renderTemplates();
$('tm').classList.add('open');
}

function switchTab(tab){
currentTab=tab;
$('tab-ex').classList.toggle('active',tab==='ex');
$('tab-day').classList.toggle('active',tab==='day');
$('add-template-btn').textContent=tab==='ex'?'‚ûï √úbungs-Template':'‚ûï Tagesplan';
renderTemplates();
}

function renderTemplates(){
let h='';
const templates=currentTab==='ex'?et:dts;
if(templates.length===0){
h=`<div class="empty">
<div class="empty-text">Keine ${currentTab==='ex'?'√úbungs-Templates':'Tagespl√§ne'} vorhanden</div>
<small>Klicke unten um zu erstellen</small>
</div>`;
}else{
templates.forEach((t,i)=>{
if(currentTab==='ex'){
h+=`<div class="template-item">
<div class="template-icon">üí™</div>
<div class="template-info">
<div class="template-name">${t.n}</div>
<div class="template-details">${t.s} S√§tze √ó ${t.r} ‚Ä¢ ${t.m}</div>
</div>
<div class="template-actions">
<button class="template-btn edit" onclick="editTemplate(${i})">‚úèÔ∏è</button>
<button class="template-btn delete" onclick="deleteTemplate(${i})">√ó</button>
</div>
</div>`;
}else{
const exCount=t.exercises?t.exercises.length:0;
h+=`<div class="template-item">
<div class="template-icon day">üìÖ</div>
<div class="template-info">
<div class="template-name">${t.n}</div>
<div class="template-details">${exCount} √úbungen</div>
</div>
<div class="template-actions">
<button class="template-btn edit" onclick="editTemplate(${i})">‚úèÔ∏è</button>
<button class="template-btn delete" onclick="deleteTemplate(${i})">√ó</button>
</div>
</div>`;
}
});
}
$('template-list').innerHTML=h;
}

function openAddTemplate(){
if(currentTab==='ex'){
openAddExerciseTemplate();
}else{
openAddDayTemplate();
}
}

function openAddExerciseTemplate(){
cm('tm');
const m=document.createElement('div');
m.className='modal open';
m.onclick=e=>{if(e.target===m)m.remove()};
m.innerHTML=`<div class="modal-content">
<div class="modal-header">
<h3>${editingTemplate!==null?'Template bearbeiten':'Neues √úbungs-Template'}</h3>
<button class="close-modal" onclick="this.parentElement.parentElement.parentElement.remove()">√ó</button>
</div>
<div class="form-group"><label class="label">Name</label><input type="text" id="tname" placeholder="z.B. Bankdr√ºcken" value="${editingTemplate!==null?et[editingTemplate].n:''}" autocomplete="off"></div>
<div class="form-group"><label class="label">S√§tze</label><input type="number" id="tsets" value="${editingTemplate!==null?et[editingTemplate].s:'3'}" min="1" max="10" inputmode="numeric"></div>
<div class="form-group"><label class="label">Wiederholungen</label><input type="text" id="treps" value="${editingTemplate!==null?et[editingTemplate].r:'8-12'}" placeholder="8-12" autocomplete="off"></div>
<div class="form-group"><label class="label">Typ</label><select id="ttype"><option value="kg" ${editingTemplate!==null&&et[editingTemplate].t==='kg'?'selected':''}>Gewicht (kg)</option><option value="m" ${editingTemplate!==null&&et[editingTemplate].t==='m'?'selected':''}>Distanz (m)</option><option value="min" ${editingTemplate!==null&&et[editingTemplate].t==='min'?'selected':''}>Zeit (min)</option></select></div>
<div class="form-group"><label class="label">Muskelgruppe</label><select id="tmuscle">${['Brust','R√ºcken','Beine','Schultern','Arme','Bauch','Cardio','Andere'].map(m=>`<option value="${m}" ${editingTemplate!==null&&et[editingTemplate].m===m?'selected':''}>${m}</option>`).join('')}</select></div>
<button class="modal-btn primary" onclick="saveExerciseTemplate()">${editingTemplate!==null?'Speichern':'Template erstellen'}</button>
<button class="modal-btn secondary" onclick="editingTemplate=null;this.parentElement.parentElement.remove()">Abbrechen</button>
</div>`;
document.body.appendChild(m);
}

function saveExerciseTemplate(){
const n=$('tname').value.trim();
const sets=parseInt($('tsets').value)||3;
const reps=$('treps').value||'8-12';
const type=$('ttype').value||'kg';
const muscle=$('tmuscle').value||'Andere';
if(n){
if(editingTemplate!==null){
et[editingTemplate]={n,s:sets,r:reps,t:type,m:muscle};
editingTemplate=null;
showToast('‚úÖ Template aktualisiert!');
}else{
et.push({n,s:sets,r:reps,t:type,m:muscle});
showToast('‚úÖ Template erstellt!');
}
s();  // This calls the save function
// Close the creation modal
const modals=document.querySelectorAll('.modal.open');
modals.forEach(m=>{
if(m.querySelector('#tname'))m.remove();
});
// Refresh and reopen template list
renderTemplates();
$('tm').classList.add('open');
}
}

function openAddDayTemplate(){
cm('tm');
const m=document.createElement('div');
m.className='modal open';
m.id='day-template-modal';
m.onclick=e=>{if(e.target===m){editingTemplate=null;window.tempDayExercises=null;m.remove()}};
window.tempDayExercises=editingTemplate!==null&&dts[editingTemplate]&&dts[editingTemplate].exercises?[...dts[editingTemplate].exercises]:[];
let h=`<div class="modal-content">
<div class="modal-header">
<h3>${editingTemplate!==null?'Tagesplan bearbeiten':'Neuer Tagesplan'}</h3>
<button class="close-modal" onclick="editingTemplate=null;window.tempDayExercises=null;this.parentElement.parentElement.parentElement.remove()">√ó</button>
</div>
<div class="form-group"><label class="label">Name</label><input type="text" id="dname" placeholder="z.B. Push Day" value="${editingTemplate!==null&&dts[editingTemplate]?dts[editingTemplate].n:''}" autocomplete="off"></div>
<div class="form-group"><label class="label">√úbungen</label><div id="day-exercises">`;
// Initial render of exercises
if(window.tempDayExercises.length>0){
window.tempDayExercises.forEach((ex,i)=>{
h+=`<div class="template-item">
<div class="template-info">
<div class="template-name">${ex.n}</div>
<div class="template-details">${ex.s} S√§tze √ó ${ex.r} ‚Ä¢ ${ex.m}</div>
</div>
<button class="template-btn delete" onclick="removeFromDayTemplate(${i})">√ó</button>
</div>`;
});
}else{
h+='<div style="padding:10px;color:#8E8E93;text-align:center">Noch keine √úbungen</div>';
}
h+=`</div></div>
<button class="modal-btn purple" onclick="addExerciseToDayTemplate()">‚ûï √úbung hinzuf√ºgen</button>
<button class="modal-btn primary" onclick="saveDayTemplate()">${editingTemplate!==null?'Speichern':'Tagesplan erstellen'}</button>
<button class="modal-btn secondary" onclick="editingTemplate=null;window.tempDayExercises=null;this.parentElement.parentElement.remove()">Abbrechen</button>
</div>`;
m.innerHTML=h;
document.body.appendChild(m);
}

function renderDayExercises(){
const container=$('day-exercises');
if(!container)return; // Safety check if element doesn't exist
let h='';
if(window.tempDayExercises&&window.tempDayExercises.length>0){
window.tempDayExercises.forEach((ex,i)=>{
h+=`<div class="template-item">
<div class="template-info">
<div class="template-name">${ex.n}</div>
<div class="template-details">${ex.s} S√§tze √ó ${ex.r} ‚Ä¢ ${ex.m}</div>
</div>
<button class="template-btn delete" onclick="removeFromDayTemplate(${i})">√ó</button>
</div>`;
});
}else{
h='<div style="padding:10px;color:#8E8E93;text-align:center">Noch keine √úbungen</div>';
}
container.innerHTML=h;
}

function addExerciseToDayTemplate(){
const parent=document.getElementById('day-template-modal');
if(parent)parent.style.display='none';
const m=document.createElement('div');
m.className='modal open';
m.onclick=e=>{if(e.target===m){m.remove();if(parent)parent.style.display='flex';}};
let h=`<div class="modal-content">
<div class="modal-header">
<h3>√úbung ausw√§hlen</h3>
<button class="close-modal" onclick="this.parentElement.parentElement.parentElement.remove();const p=document.getElementById('day-template-modal');if(p)p.style.display='flex'">√ó</button>
</div>`;
if(et.length>0){
h+='<div class="template-list">';
et.forEach((t,i)=>{
h+=`<div class="template-item">
<div class="template-icon">üí™</div>
<div class="template-info">
<div class="template-name">${t.n}</div>
<div class="template-details">${t.s} S√§tze √ó ${t.r} ‚Ä¢ ${t.m}</div>
</div>
<button class="template-btn use" onclick="selectForDayTemplate(${i})">+</button>
</div>`;
});
h+='</div>';
}else{
h+='<div class="empty"><div class="empty-text">Keine √úbungs-Templates vorhanden</div><small>Erstelle zuerst √úbungs-Templates</small></div>';
}
h+='<button class="modal-btn secondary" onclick="this.parentElement.parentElement.remove();const p=document.getElementById(\'day-template-modal\');if(p)p.style.display=\'flex\'">Abbrechen</button>';
h+='</div>';
m.innerHTML=h;
document.body.appendChild(m);
}

function selectForDayTemplate(i){
if(!window.tempDayExercises)window.tempDayExercises=[];
window.tempDayExercises.push({...et[i]});
showToast('‚úÖ √úbung hinzugef√ºgt');
// Close the selection modal
const selectionModal=document.querySelector('.modal.open');
if(selectionModal&&!selectionModal.querySelector('#day-exercises')){
selectionModal.remove();
}
// Show the day template modal again
const parent=document.getElementById('day-template-modal');
if(parent){
parent.style.display='flex';
renderDayExercises();
}
}

function removeFromDayTemplate(i){
if(window.tempDayExercises){
window.tempDayExercises.splice(i,1);
showToast('‚ùå √úbung entfernt');
// Re-render the list directly
const dayModal=document.getElementById('day-template-modal');
if(dayModal){
const container=dayModal.querySelector('#day-exercises');
if(container){
let h='';
if(window.tempDayExercises.length>0){
window.tempDayExercises.forEach((ex,idx)=>{
h+=`<div class="template-item">
<div class="template-info">
<div class="template-name">${ex.n}</div>
<div class="template-details">${ex.s} S√§tze √ó ${ex.r} ‚Ä¢ ${ex.m}</div>
</div>
<button class="template-btn delete" onclick="removeFromDayTemplate(${idx})">√ó</button>
</div>`;
});
}else{
h='<div style="padding:10px;color:#8E8E93;text-align:center">Noch keine √úbungen</div>';
}
container.innerHTML=h;
}
}
}
}

function saveDayTemplate(){
const n=$('dname').value.trim();
if(n&&window.tempDayExercises&&window.tempDayExercises.length>0){
if(editingTemplate!==null){
dts[editingTemplate]={n,exercises:[...window.tempDayExercises]};
editingTemplate=null;
showToast('‚úÖ Tagesplan aktualisiert!');
}else{
dts.push({n,exercises:[...window.tempDayExercises]});
showToast('‚úÖ Tagesplan erstellt!');
}
s();  // Save to localStorage and GitHub
window.tempDayExercises=null;
// Close the creation modal
const dayModal=document.getElementById('day-template-modal');
if(dayModal)dayModal.remove();
// Refresh and reopen template list
renderTemplates();
$('tm').classList.add('open');
}else{
showToast('‚ö†Ô∏è Name und mindestens eine √úbung erforderlich!');
}
}

function editTemplate(i){
editingTemplate=i;
if(currentTab==='ex'){
openAddExerciseTemplate();
}else{
openAddDayTemplate();
}
}

function deleteTemplate(i){
if(confirm(`${currentTab==='ex'?'Template':'Tagesplan'} wirklich l√∂schen?`)){
if(currentTab==='ex'){
et.splice(i,1);
}else{
dts.splice(i,1);
}
s();renderTemplates();
}
}

// Modal Functions
function cm(i){$(i).classList.remove('open')}
function openSettings(){
updateGithubStatus();
$('sm').classList.add('open');
}

function updateGithubStatus(){
const status = $('github-status');
if(status && localStorage.getItem('ght')){
const lastSync = localStorage.getItem('gls');
if(lastSync){
const date = new Date(lastSync);
const time = date.toLocaleTimeString('de', {hour: '2-digit', minute: '2-digit'});
const day = date.toLocaleDateString('de', {day: '2-digit', month: '2-digit'});
status.innerHTML = `‚úÖ Aktiv ‚Ä¢ Sync: ${day} ${time}`;
} else {
status.textContent = '‚úÖ Aktiviert';
}
} else {
status.textContent = 'Automatische Synchronisation einrichten';
}
}

// Export
function xp(){
cm('sm');
const data={w,et,dts};
const d=JSON.stringify(data,null,2);
const b=new Blob([d],{type:'application/json'});
const u=URL.createObjectURL(b);
const a=document.createElement('a');
a.href=u;
a.download=`gym-${dt}.json`;
a.click();
}

// Import
function im(){
cm('sm');
const i=document.createElement('input');
i.type='file';
i.accept='.json';
i.onchange=e=>{
const r=new FileReader();
r.onload=ev=>{
try{
const data=JSON.parse(ev.target.result);
if(data.w)w=data.w;
else if(!data.et&&!data.dts)w=data;
if(data.et)et=data.et;
if(data.dts)dts=data.dts;
s();r();showToast('‚úÖ Import erfolgreich!');
}catch{showToast('‚ùå Fehler beim Import')}
};
r.readAsText(e.target.files[0]);
};
i.click();
}

// GitHub Dialog
function cs(){
cm('sm');
setTimeout(()=>{
const m=document.createElement('div');
m.className='modal open';
m.onclick=e=>{if(e.target===m)m.remove()};
m.innerHTML=`<div class="modal-content">
<div class="modal-header">
<h3>GitHub Sync</h3>
<button class="close-modal" onclick="this.parentElement.parentElement.parentElement.remove()">√ó</button>
</div>
<div class="form-group"><label class="label">Token</label><input type="password" id="gt" placeholder="ghp_..." value="${localStorage.getItem('ght')||''}" autocomplete="off"></div>
<div class="form-group"><label class="label">Username</label><input type="text" id="gu" placeholder="dein-username" value="${localStorage.getItem('ghu')||''}" autocomplete="off"></div>
<div class="form-group"><label class="label">Repository</label><input type="text" id="gr" placeholder="Workout-tracker" value="${localStorage.getItem('ghr')||'Workout-tracker'}" autocomplete="off"></div>
<button class="modal-btn primary" onclick="gss()">Speichern & Aktivieren</button>
${localStorage.getItem('ght')?'<button class="modal-btn success" onclick="ghl().then(()=>{r();alert(\'‚úÖ Von GitHub geladen\')})">Von GitHub laden</button>':''}
${localStorage.getItem('ght')?'<button class="modal-btn danger" onclick="if(confirm(\'GitHub Sync wirklich deaktivieren?\')){localStorage.removeItem(\'ght\');localStorage.removeItem(\'ghu\');localStorage.removeItem(\'ghr\');alert(\'Deaktiviert\');this.parentElement.parentElement.remove()}">Deaktivieren</button>':''}
<button class="modal-btn secondary" onclick="this.parentElement.parentElement.remove()">Abbrechen</button>
</div>`;
document.body.appendChild(m);
},100);
}

function gss(){
try{
const t=$('gt').value,u=$('gu').value,r=$('gr').value;
if(t&&u){
localStorage.setItem('ght',t);
localStorage.setItem('ghu',u);
localStorage.setItem('ghr',r);
ghl().then(()=>{r();ghs()});
showToast('‚úÖ GitHub Sync aktiviert!');
const modal=document.querySelector('.modal.open');
if(modal)modal.remove();
}
}catch(e){
console.log('GitHub save error:',e);
showToast('‚ùå Fehler beim Speichern');
}
}

async function ghs(){
const t=localStorage.getItem('ght'),u=localStorage.getItem('ghu'),r=localStorage.getItem('ghr')||'Workout-tracker';
if(!t||!u)return;
try{
const data={w,et,dts,d:new Date()};
const d=btoa(unescape(encodeURIComponent(JSON.stringify(data))));
const s=await gsha();
await fetch(`https://api.github.com/repos/${u}/${r}/contents/data.json`,{
method:'PUT',
headers:{'Authorization':`token ${t}`},
body:JSON.stringify({message:`Update ${new Date().toLocaleString('de')}`,content:d,sha:s})
});
localStorage.setItem('gls', new Date().toISOString());
updateGithubStatus();
}catch(e){console.log('GitHub save error:',e)}
}

async function gsha(){
const t=localStorage.getItem('ght'),u=localStorage.getItem('ghu'),r=localStorage.getItem('ghr')||'Workout-tracker';
try{
const res=await fetch(`https://api.github.com/repos/${u}/${r}/contents/data.json`,{
headers:{'Authorization':`token ${t}`}
});
if(res.ok)return(await res.json()).sha;
}catch{}
}

async function ghl(){
const t=localStorage.getItem('ght'),u=localStorage.getItem('ghu'),r=localStorage.getItem('ghr')||'Workout-tracker';
if(!t||!u)return;
try{
const res=await fetch(`https://api.github.com/repos/${u}/${r}/contents/data.json`,{
headers:{'Authorization':`token ${t}`}
});
if(res.ok){
const d=await res.json();
const c=JSON.parse(decodeURIComponent(escape(atob(d.content))));
if(c.w){
w=c.w;
et=c.et||[];
dts=c.dts||[];
const data={w,et,dts};
localStorage.setItem('w',JSON.stringify(data));
localStorage.setItem('gls', new Date().toISOString());
updateGithubStatus();
console.log('‚úÖ Von GitHub geladen');
}
}else if(res.status===404){
console.log('üìù Erstelle neue data.json mit leeren Daten');
w={};et=[];dts=[];
await ghs();
}
}catch(e){console.log('GitHub load error:',e)}
}

// Init
fd();
if(localStorage.getItem('ght')){
ghl().then(()=>r());
}else{
l();
r();
}

// iOS optimizations
document.addEventListener('touchmove',e=>{if(e.scale!==1)e.preventDefault()},{passive:false});
</script>
</body>
</html>
