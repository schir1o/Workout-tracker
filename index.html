<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#000000">
<title>Darios Gym</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none;-webkit-user-select:none;user-select:none}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",system-ui,sans-serif;background:#000;color:#fff;padding:0;margin:0;overscroll-behavior:none;min-height:100vh;-webkit-font-smoothing:antialiased}
.app{min-height:100vh;display:flex;flex-direction:column;background:#000}

/* Header */
.header{background:linear-gradient(135deg,#007AFF,#0051D5);padding:14px 16px;padding-top:calc(14px + env(safe-area-inset-top));position:fixed;top:0;left:0;right:0;z-index:100;box-shadow:0 1px 10px rgba(0,0,0,0.3);backdrop-filter:blur(20px)}
.header-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.header h1{font-size:26px;font-weight:700;letter-spacing:-0.5px}
.settings-btn{width:38px;height:38px;background:rgba(255,255,255,0.2);border:none;border-radius:10px;color:#fff;font-size:18px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all 0.2s;backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px)}
.settings-btn:active{transform:scale(0.92);background:rgba(255,255,255,0.3)}

/* Navigation */
.nav{display:flex;gap:6px;align-items:center}
.nav-btn{background:rgba(255,255,255,0.15);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border:none;color:#fff;padding:10px;border-radius:10px;font-size:18px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;min-width:44px;min-height:44px;transition:all 0.2s}
.nav-btn:active{background:rgba(255,255,255,0.25);transform:scale(0.95)}
.date-btn{flex:1;text-align:center;font-size:15px;font-weight:600;padding:10px 16px;position:relative}
.date-input{position:absolute;top:0;left:0;width:100%;height:100%;opacity:0;cursor:pointer}

/* Content */
.content{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:16px;padding-top:calc(140px + env(safe-area-inset-top));padding-bottom:calc(30px + env(safe-area-inset-bottom));background:#000}

/* Cards & Exercises */
.exercise{background:linear-gradient(145deg,#1c1c1e,#242426);border-radius:16px;padding:14px;margin-bottom:14px;border:1px solid #2c2c2e;box-shadow:0 4px 12px rgba(0,0,0,0.2)}
.exercise-header{display:flex;align-items:center;margin-bottom:12px;gap:6px}
.exercise-name{font-size:17px;font-weight:600;flex:1}
.muscle-tag{background:linear-gradient(135deg,#007AFF,#0051D5);padding:5px 12px;border-radius:20px;font-size:11px;font-weight:600;white-space:nowrap;box-shadow:0 2px 8px rgba(0,122,255,0.3)}
.edit-btn,.delete-btn{border:none;color:#fff;width:36px;height:36px;border-radius:10px;font-size:18px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all 0.2s;box-shadow:0 2px 8px rgba(0,0,0,0.2)}
.edit-btn{background:linear-gradient(135deg,#007AFF,#0051D5)}
.delete-btn{background:linear-gradient(135deg,#FF3B30,#FF2D20)}
.edit-btn:active,.delete-btn:active{transform:scale(0.92)}

/* Sets */
.set{display:grid;grid-template-columns:38px 1fr 72px 46px;gap:8px;align-items:center;padding:10px;background:linear-gradient(145deg,#2c2c2e,#323234);border-radius:12px;margin-bottom:8px;transition:all 0.3s;border:1px solid #3a3a3c}
.set.done{background:linear-gradient(145deg,rgba(52,199,89,0.15),rgba(52,199,89,0.1));border:1px solid rgba(52,199,89,0.4);box-shadow:0 2px 12px rgba(52,199,89,0.2)}
.set-num{width:38px;height:38px;background:linear-gradient(135deg,#007AFF,#0051D5);border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:15px;box-shadow:0 2px 8px rgba(0,122,255,0.3)}
.set.done .set-num{background:linear-gradient(135deg,#34C759,#30B350)}
.input{background:linear-gradient(145deg,#1c1c1e,#242426);border:1px solid #3a3a3c;border-radius:10px;padding:10px;color:#fff;font-size:16px;font-weight:500;text-align:center;width:100%;-webkit-appearance:none;transition:all 0.2s}
.input:focus{border-color:#007AFF;outline:none;box-shadow:0 0 0 3px rgba(0,122,255,0.2)}
.check-btn{width:46px;height:40px;border-radius:12px;background:linear-gradient(145deg,#2c2c2e,#323234);border:2px solid #3a3a3c;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:22px;transition:all 0.3s}
.check-btn.checked{background:linear-gradient(135deg,#34C759,#30B350);border-color:#34C759;color:#fff;box-shadow:0 2px 12px rgba(52,199,89,0.4)}
.check-btn:active{transform:scale(0.92)}

/* Empty State */
.empty{text-align:center;padding:60px 20px;color:#8E8E93}
.empty-icon{font-size:56px;margin-bottom:16px;filter:grayscale(20%)}
.empty-text{font-size:20px;font-weight:600;margin-bottom:8px}
.empty small{display:block;margin-top:4px;font-size:14px;opacity:0.7}

/* Buttons */
.add-btn{width:100%;padding:16px;background:linear-gradient(135deg,#007AFF,#0051D5);border:none;border-radius:14px;color:#fff;font-size:16px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;margin-top:16px;transition:all 0.2s;box-shadow:0 4px 12px rgba(0,122,255,0.3)}
.add-btn:active{transform:scale(0.98);box-shadow:0 2px 8px rgba(0,122,255,0.3)}
.template-btn{background:linear-gradient(135deg,#5E5CE6,#4B47D5)}
.template-btn:active{box-shadow:0 2px 8px rgba(94,92,230,0.3)}

/* Modal */
.modal{position:fixed;inset:0;background:rgba(0,0,0,0.95);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);z-index:999;display:none;align-items:flex-end;padding:0}
.modal.open{display:flex}
.modal-content{background:linear-gradient(180deg,#1c1c1e,#18181a);border-radius:24px 24px 0 0;padding:20px;width:100%;max-height:85vh;overflow-y:auto;-webkit-overflow-scrolling:touch;padding-bottom:calc(20px + env(safe-area-inset-bottom));animation:slideUp 0.3s cubic-bezier(0.34,1.56,0.64,1);box-shadow:0 -4px 20px rgba(0,0,0,0.3)}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:12px;border-bottom:1px solid #2c2c2e}
.modal h3{font-size:24px;font-weight:700}
.close-modal{width:32px;height:32px;background:linear-gradient(145deg,#3a3a3c,#2c2c2e);border:none;border-radius:50%;color:#fff;font-size:18px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all 0.2s}
.close-modal:active{transform:scale(0.9)}
.form-group{margin-bottom:18px}
.label{display:block;margin-bottom:8px;font-size:12px;font-weight:600;color:#8E8E93;text-transform:uppercase;letter-spacing:0.5px}
input[type="text"],input[type="number"],input[type="password"],select{width:100%;padding:14px;background:linear-gradient(145deg,#2c2c2e,#323234);border:1px solid #3a3a3c;border-radius:12px;color:#fff;font-size:16px;font-weight:400;-webkit-appearance:none;transition:all 0.2s}
input:focus,select:focus{border-color:#007AFF;outline:none;box-shadow:0 0 0 3px rgba(0,122,255,0.2)}
select{cursor:pointer;background-image:url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%238E8E93' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");background-repeat:no-repeat;background-position:right 12px center;background-size:18px;padding-right:40px}
.modal-btn{width:100%;padding:15px;border:none;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer;margin-bottom:8px;transition:all 0.2s;box-shadow:0 3px 10px rgba(0,0,0,0.2)}
.modal-btn.primary{background:linear-gradient(135deg,#007AFF,#0051D5);color:#fff}
.modal-btn.secondary{background:linear-gradient(145deg,#3a3a3c,#2c2c2e);color:#fff}
.modal-btn.danger{background:linear-gradient(135deg,#FF3B30,#FF2D20);color:#fff}
.modal-btn.success{background:linear-gradient(135deg,#34C759,#30B350);color:#fff}
.modal-btn.purple{background:linear-gradient(135deg,#5E5CE6,#4B47D5);color:#fff}
.modal-btn:active{transform:scale(0.98);box-shadow:0 1px 5px rgba(0,0,0,0.2)}

/* Settings Items */
.settings-section{margin-bottom:24px}
.settings-title{font-size:12px;font-weight:600;color:#8E8E93;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:12px;padding-left:4px}
.settings-item{background:linear-gradient(145deg,#2c2c2e,#323234);border-radius:12px;padding:14px;margin-bottom:10px;display:flex;align-items:center;gap:12px;cursor:pointer;transition:all 0.2s;border:1px solid #3a3a3c}
.settings-item:active{transform:scale(0.98);background:linear-gradient(145deg,#3a3a3c,#424244)}
.settings-icon{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;box-shadow:0 2px 8px rgba(0,0,0,0.2)}
.settings-icon.export{background:linear-gradient(135deg,#5E5CE6,#4B47D5)}
.settings-icon.import{background:linear-gradient(135deg,#FF9500,#FF8000)}
.settings-icon.github{background:linear-gradient(135deg,#34C759,#30B350)}
.settings-icon.templates{background:linear-gradient(135deg,#FF2D55,#FF1744)}
.settings-info{flex:1}
.settings-name{font-size:16px;font-weight:600;margin-bottom:2px}
.settings-desc{font-size:13px;color:#8E8E93}
.settings-arrow{color:#3a3a3c;font-size:18px}

/* Template List */
.template-list{margin-top:16px}
.template-item{background:linear-gradient(145deg,#2c2c2e,#323234);border-radius:12px;padding:14px;margin-bottom:10px;display:flex;align-items:center;gap:12px;border:1px solid #3a3a3c}
.template-icon{width:44px;height:44px;background:linear-gradient(135deg,#007AFF,#0051D5);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:22px;box-shadow:0 2px 8px rgba(0,122,255,0.3)}
.template-icon.day{background:linear-gradient(135deg,#5E5CE6,#4B47D5)}
.template-info{flex:1}
.template-name{font-size:16px;font-weight:600}
.template-details{font-size:13px;color:#8E8E93;margin-top:2px}
.template-actions{display:flex;gap:8px}
.template-btn{width:38px;height:38px;border:none;border-radius:10px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:18px;transition:all 0.2s;box-shadow:0 2px 8px rgba(0,0,0,0.2)}
.template-btn.edit{background:linear-gradient(135deg,#007AFF,#0051D5);color:#fff}
.template-btn.delete{background:linear-gradient(135deg,#FF3B30,#FF2D20);color:#fff}
.template-btn.use{background:linear-gradient(135deg,#34C759,#30B350);color:#fff}
.template-btn:active{transform:scale(0.92)}

/* Tabs */
.tabs{display:flex;gap:8px;margin-bottom:16px}
.tab{flex:1;padding:12px;background:linear-gradient(145deg,#2c2c2e,#323234);border:1px solid #3a3a3c;border-radius:12px;text-align:center;font-size:14px;font-weight:600;cursor:pointer;transition:all 0.2s}
.tab.active{background:linear-gradient(135deg,#007AFF,#0051D5);border-color:#007AFF;color:#fff;box-shadow:0 2px 12px rgba(0,122,255,0.3)}

/* Choice Grid */
.choice-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px}
.choice-card{background:linear-gradient(145deg,#2c2c2e,#323234);border:2px solid #3a3a3c;border-radius:16px;padding:24px;text-align:center;cursor:pointer;transition:all 0.2s}
.choice-card:active{transform:scale(0.95);background:linear-gradient(145deg,#3a3a3c,#424244)}
.choice-icon{font-size:40px;margin-bottom:10px}
.choice-title{font-size:16px;font-weight:600;margin-bottom:4px}
.choice-desc{font-size:12px;color:#8E8E93}

/* Toast Notification */
.toast{position:fixed;top:calc(20px + env(safe-area-inset-top));left:50%;transform:translateX(-50%);background:linear-gradient(135deg,#34C759,#30B350);color:#fff;padding:14px 24px;border-radius:14px;font-size:15px;font-weight:600;z-index:10000;animation:toastIn 0.3s cubic-bezier(0.34,1.56,0.64,1),toastOut 0.5s 2s forwards;box-shadow:0 4px 16px rgba(52,199,89,0.4)}
@keyframes toastIn{from{transform:translateX(-50%) translateY(-100%);opacity:0}to{transform:translateX(-50%) translateY(0);opacity:1}}
@keyframes toastOut{from{transform:translateX(-50%) translateY(0);opacity:1}to{transform:translateX(-50%) translateY(-20px);opacity:0}}

/* Responsive */
@media (max-width:375px){
.header h1{font-size:24px}
.set{grid-template-columns:36px 1fr 65px 44px;gap:6px}
.input{font-size:15px;padding:8px}
.modal-content{padding:16px}
.choice-card{padding:20px}
}
</style>
</head>
<body>
<div class="app">
<div class="header">
<div class="header-top">
<h1>💪 Darios Gym</h1>
<div style="display:flex;gap:8px">
<button class="settings-btn" onclick="openStats()" style="background:rgba(255,255,255,0.2)">📊</button>
<button class="settings-btn" onclick="openSettings()">⚙️</button>
</div>
</div>
<div class="nav">
<button class="nav-btn" onclick="cd(-1)">←</button>
<div class="nav-btn date-btn" id="dd">
<span id="date-text"></span>
<input type="date" class="date-input" id="di" onchange="sd(this.value)">
</div>
<button class="nav-btn" onclick="cd(1)">→</button>
</div>
</div>

<div class="content" id="ex"></div>
</div>

<!-- Add Exercise Modal -->
<div class="modal" id="am">
<div class="modal-content">
<div class="modal-header">
<h3>Hinzufügen</h3>
<button class="close-modal" onclick="cm('am')">×</button>
</div>
<div class="choice-grid">
<div class="choice-card" onclick="showManualAdd()">
<div class="choice-icon">✏️</div>
<div class="choice-title">Neue Übung</div>
<div class="choice-desc">Manuell erstellen</div>
</div>
<div class="choice-card" onclick="showTemplateSelect()">
<div class="choice-icon">💪</div>
<div class="choice-title">Übungs-Template</div>
<div class="choice-desc">Aus Vorlage wählen</div>
</div>
</div>
<div id="day-template-option"></div>
</div>
</div>

<!-- Manual Add Form -->
<div class="modal" id="mam">
<div class="modal-content">
<div class="modal-header">
<h3>Neue Übung</h3>
<button class="close-modal" onclick="cm('mam')">×</button>
</div>
<div class="form-group">
<label class="label">Name</label>
<input type="text" id="nn" placeholder="z.B. Bankdrücken" autocomplete="off">
</div>
<div class="form-group">
<label class="label">Sätze</label>
<input type="number" id="ns" value="3" min="1" max="10" inputmode="numeric">
</div>
<div class="form-group">
<label class="label">Wiederholungen</label>
<input type="text" id="nr" value="8-12" placeholder="8-12" autocomplete="off">
</div>
<div class="form-group">
<label class="label">Typ</label>
<select id="nt">
<option value="kg">Gewicht (kg)</option>
<option value="m">Distanz (m)</option>
<option value="min">Zeit (min)</option>
</select>
</div>
<div class="form-group">
<label class="label">Muskelgruppe</label>
<select id="nm">
<option value="Brust">Brust</option>
<option value="Rücken">Rücken</option>
<option value="Beine">Beine</option>
<option value="Schultern">Schultern</option>
<option value="Arme">Arme</option>
<option value="Bauch">Bauch</option>
<option value="Cardio">Cardio</option>
<option value="Andere">Andere</option>
</select>
</div>
<button class="modal-btn primary" onclick="ae()">Übung hinzufügen</button>
<button class="modal-btn purple" onclick="saveAsTemplate()">Als Template speichern</button>
<button class="modal-btn secondary" onclick="cm('mam')">Abbrechen</button>
</div>
</div>

<!-- Template Select Modal -->
<div class="modal" id="tsm">
<div class="modal-content">
<div class="modal-header">
<h3>Template wählen</h3>
<button class="close-modal" onclick="cm('tsm')">×</button>
</div>
<div id="template-select-list"></div>
<button class="modal-btn secondary" onclick="cm('tsm');$('am').classList.add('open')">Zurück</button>
</div>
</div>

<!-- Settings Modal -->
<div class="modal" id="sm">
<div class="modal-content">
<div class="modal-header">
<h3>Einstellungen</h3>
<button class="close-modal" onclick="cm('sm')">×</button>
</div>
<div class="settings-section">
<div class="settings-title">Templates</div>
<div class="settings-item" onclick="openTemplates()">
<div class="settings-icon templates">📝</div>
<div class="settings-info">
<div class="settings-name">Templates verwalten</div>
<div class="settings-desc">Übungen und Tagespläne bearbeiten</div>
</div>
<div class="settings-arrow">›</div>
</div>
</div>
<div class="settings-section">
<div class="settings-title">Daten</div>
<div class="settings-item" onclick="xp()">
<div class="settings-icon export">📤</div>
<div class="settings-info">
<div class="settings-name">Export</div>
<div class="settings-desc">Trainingsdaten als JSON exportieren</div>
</div>
<div class="settings-arrow">›</div>
</div>
<div class="settings-item" onclick="im()">
<div class="settings-icon import">📥</div>
<div class="settings-info">
<div class="settings-name">Import</div>
<div class="settings-desc">Trainingsdaten aus JSON importieren</div>
</div>
<div class="settings-arrow">›</div>
</div>
</div>
<div class="settings-section">
<div class="settings-title">Synchronisation</div>
<div class="settings-item" onclick="cs()">
<div class="settings-icon github">☁️</div>
<div class="settings-info">
<div class="settings-name">GitHub Sync</div>
<div class="settings-desc" id="github-status">Automatische Synchronisation einrichten</div>
</div>
<div class="settings-arrow">›</div>
</div>
</div>
</div>
</div>

<!-- Templates Modal -->
<div class="modal" id="tm">
<div class="modal-content">
<div class="modal-header">
<h3>Templates</h3>
<button class="close-modal" onclick="cm('tm')">×</button>
</div>
<div class="tabs">
<div class="tab active" id="tab-ex" onclick="switchTab('ex')">Übungen</div>
<div class="tab" id="tab-day" onclick="switchTab('day')">Tagespläne</div>
</div>
<div id="template-list"></div>
<button class="modal-btn primary" id="add-template-btn" onclick="openAddTemplate()">➕ Übungs-Template</button>
<button class="modal-btn secondary" onclick="cm('tm')">Schließen</button>
</div>
</div>

<script>
const $=id=>document.getElementById(id);
let dt=new Date().toISOString().split('T')[0];
let w={};
let et=[];  // Exercise templates
let dts=[];  // Day templates
let currentTab='ex';
let editingTemplate=null;

// Load/Save
function l(){
try{
const data=JSON.parse(localStorage.getItem('w'))||{};
w=data.w||data||{};
et=data.et||[];
dts=data.dts||[];
}catch{w={};et=[];dts=[];}
}

function s(){
const data={w,et,dts,d:new Date()};
localStorage.setItem('w',JSON.stringify(data));
if(localStorage.getItem('ght'))ghs();
}

// Date
function fd(){
const d=new Date(dt+'T12:00');
const mo=['So','Mo','Di','Mi','Do','Fr','Sa'][d.getDay()];
$('date-text').textContent=`${mo}, ${d.getDate()}.${(d.getMonth()+1+'').padStart(2,'0')}.${d.getFullYear()}`;
$('di').value=dt;
}

function cd(n){
const d=new Date(dt+'T12:00');
d.setDate(d.getDate()+n);
dt=d.toISOString().split('T')[0];
fd();r();
}

function sd(v){dt=v;fd();r()}

// Render
function r(){
const k=dt;
const d=w[k];
let h='';
if(d&&d.rest){
h=`<div class="empty">
<div class="empty-icon">😴</div>
<div class="empty-text">Ruhetag</div>
<small>Gut erholt für das nächste Training!</small>
</div>`;
h+=`<button class="add-btn" onclick="removeRestDay()">💪 Doch trainieren</button>`;
}else if(!d||!d.e||d.e.length===0){
h=`<div class="empty">
<div class="empty-icon">🏋️‍♂️</div>
<div class="empty-text">Noch keine Übungen</div>
<small>Starte dein Training mit dem Button unten</small>
</div>`;
}else{
d.e.forEach((x,i)=>{
const tp=x.t||'kg';
const ph=tp==='m'?'Meter':tp==='min'?'Min':'kg';
const ph2=tp==='kg'?'Wdh':'Zeit';
h+=`<div class="exercise">
<div class="exercise-header">
<div class="exercise-name">${x.n}</div>
<div class="muscle-tag">${x.m||'Andere'}</div>
<button class="edit-btn" onclick="editExercise(${i})" style="background:#007AFF;border:none;color:#fff;width:36px;height:36px;border-radius:10px;font-size:18px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all 0.2s">✏️</button>
<button class="delete-btn" onclick="if(confirm('Übung wirklich löschen?'))re(${i})">×</button>
</div>`;
x.s.forEach((s,j)=>{
h+=`<div class="set ${s.d?'done':''}">
<div class="set-num">${j+1}</div>
<input class="input" placeholder="${ph}" value="${s.w||''}" onchange="us(${i},${j},'w',this.value)" inputmode="${tp==='kg'?'decimal':'numeric'}">
<input class="input" placeholder="${ph2}" value="${s.r||''}" onchange="us(${i},${j},'r',this.value)" inputmode="numeric">
<button class="check-btn ${s.d?'checked':''}" onclick="tg(${i},${j})">${s.d?'✓':''}</button>
</div>`;
});
h+=`</div>`;
});
}
if(!(d&&d.rest)){
h+=`<button class="add-btn" onclick="openAddModal()">➕ Neue Übung</button>`;
if(!d||!d.e||d.e.length===0){
h+=`<button class="add-btn" style="background:#5E5CE6" onclick="markRestDay()">😴 Ruhetag markieren</button>`;
}
}
$('ex').innerHTML=h;
}

function removeRestDay(){
const k=dt;
if(w[k])delete w[k].rest;
s();r();
showToast('💪 Bereit zum Training!');
}

// Update Set
function us(i,j,f,v){
const k=dt;
if(!w[k])w[k]={e:[]};
if(w[k].e[i]&&w[k].e[i].s[j]){
w[k].e[i].s[j][f]=v;
s();
}
}

// Toggle Done
function tg(i,j){
const k=dt;
if(w[k]&&w[k].e[i]&&w[k].e[i].s[j]){
w[k].e[i].s[j].d=!w[k].e[i].s[j].d;
s();r();
}
}

// Toast notification
function showToast(msg){
const t=document.createElement('div');
t.className='toast';
t.textContent=msg;
document.body.appendChild(t);
setTimeout(()=>t.remove(),2500);
}

// Add Exercise
function ae(){
const n=$('nn').value.trim();
const st=parseInt($('ns').value)||3;
const rp=$('nr').value||'8-12';
const tp=$('nt').value||'kg';
const mg=$('nm').value||'Andere';
if(n){
const k=dt;
if(!w[k])w[k]={e:[]};
w[k].e.push({n,r:rp,t:tp,m:mg,s:Array(st).fill().map(()=>({w:'',r:'',d:0}))});
$('nn').value='';$('ns').value='3';$('nr').value='8-12';$('nt').value='kg';$('nm').value='Brust';
cm('mam');cm('am');s();r();
}
}

// Edit Exercise
function editExercise(i){
const k=dt;
if(!w[k]||!w[k].e||!w[k].e[i])return;
const ex=w[k].e[i];
const m=document.createElement('div');
m.className='modal open';
m.onclick=e=>{if(e.target===m)m.remove()};
m.innerHTML=`<div class="modal-content">
<div class="modal-header">
<h3>Übung bearbeiten</h3>
<button class="close-modal" onclick="this.parentElement.parentElement.parentElement.remove()">×</button>
</div>
<div class="form-group">
<label class="label">Name</label>
<input type="text" id="edit-name" value="${ex.n}" autocomplete="off">
</div>
<div class="form-group">
<label class="label">Sätze</label>
<div style="display:flex;gap:10px;align-items:center">
<button onclick="adjustSets(-1)" style="width:40px;height:40px;background:#FF3B30;border:none;border-radius:10px;color:#fff;font-size:20px;cursor:pointer">−</button>
<input type="number" id="edit-sets" value="${ex.s.length}" min="1" max="10" inputmode="numeric" style="text-align:center">
<button onclick="adjustSets(1)" style="width:40px;height:40px;background:#34C759;border:none;border-radius:10px;color:#fff;font-size:20px;cursor:pointer">+</button>
</div>
</div>
<div class="form-group">
<label class="label">Wiederholungen</label>
<input type="text" id="edit-reps" value="${ex.r||'8-12'}" placeholder="8-12" autocomplete="off">
</div>
<div class="form-group">
<label class="label">Typ</label>
<select id="edit-type">
<option value="kg" ${ex.t==='kg'?'selected':''}>Gewicht (kg)</option>
<option value="m" ${ex.t==='m'?'selected':''}>Distanz (m)</option>
<option value="min" ${ex.t==='min'?'selected':''}>Zeit (min)</option>
</select>
</div>
<div class="form-group">
<label class="label">Muskelgruppe</label>
<select id="edit-muscle">
${['Brust','Rücken','Beine','Schultern','Arme','Bauch','Cardio','Andere'].map(m=>`<option value="${m}" ${ex.m===m?'selected':''}>${m}</option>`).join('')}
</select>
</div>
<button class="modal-btn primary" onclick="saveExerciseEdit(${i})">Speichern</button>
<button class="modal-btn secondary" onclick="this.parentElement.parentElement.remove()">Abbrechen</button>
</div>`;
document.body.appendChild(m);
window.currentExerciseIndex=i;
window.currentSets=ex.s.length;
}

function adjustSets(delta){
const input=$('edit-sets');
let val=parseInt(input.value)||1;
val=Math.max(1,Math.min(10,val+delta));
input.value=val;
window.currentSets=val;
}

function saveExerciseEdit(i){
const k=dt;
if(!w[k]||!w[k].e||!w[k].e[i])return;
const name=$('edit-name').value.trim();
const sets=parseInt($('edit-sets').value)||3;
const reps=$('edit-reps').value||'8-12';
const type=$('edit-type').value||'kg';
const muscle=$('edit-muscle').value||'Andere';
if(name){
const ex=w[k].e[i];
ex.n=name;
ex.r=reps;
ex.t=type;
ex.m=muscle;
// Adjust sets array
const currentSetsCount=ex.s.length;
if(sets>currentSetsCount){
// Add new sets
for(let j=currentSetsCount;j<sets;j++){
ex.s.push({w:'',r:'',d:0});
}
}else if(sets<currentSetsCount){
// Remove sets (ask for confirmation if they have data)
const removedSets=ex.s.slice(sets);
const hasData=removedSets.some(s=>s.w||s.r);
if(hasData&&!confirm('Die letzten Sätze haben Daten. Wirklich löschen?')){
return;
}
ex.s=ex.s.slice(0,sets);
}
s();r();
showToast('✅ Übung aktualisiert');
document.querySelector('.modal.open').remove();
}
}

// Remove Exercise
function re(i){
const k=dt;
if(w[k]&&w[k].e){
w[k].e.splice(i,1);
if(w[k].e.length===0)delete w[k];
s();r();
}
}

// Mark Rest Day
function markRestDay(){
const k=dt;
if(!w[k])w[k]={};
w[k].rest=true;
s();r();
showToast('😴 Ruhetag markiert');
}

function removeRestDay(){
const k=dt;
if(w[k])delete w[k].rest;
s();r();
showToast('💪 Bereit zum Training!');
}

// Stats Functions
function openStats(){
const m=document.createElement('div');
m.className='modal open';
m.onclick=e=>{if(e.target===m)m.remove()};

// Calculate stats
const stats=calculateStats();
let h=`<div class="modal-content" style="max-height:90vh">
<div class="modal-header">
<h3>📊 Statistiken</h3>
<button class="close-modal" onclick="this.parentElement.parentElement.parentElement.remove()">×</button>
</div>`;

// Streak and Training Days with dates
h+=`<div class="settings-section">
<div class="settings-title">Training Übersicht</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px">
<div style="background:linear-gradient(145deg,#2c2c2e,#323234);padding:16px;border-radius:14px;text-align:center;border:1px solid #3a3a3c">
<div style="font-size:32px;margin-bottom:4px">🔥 ${stats.streak}</div>
<div style="font-size:12px;color:#8E8E93;margin-bottom:4px">Tage Streak</div>
<div style="font-size:10px;color:#007AFF">${stats.streakStart ? `seit ${new Date(stats.streakStart).toLocaleDateString('de',{day:'2-digit',month:'2-digit'})}` : 'Starte heute!'}</div>
</div>
<div style="background:linear-gradient(145deg,#2c2c2e,#323234);padding:16px;border-radius:14px;text-align:center;border:1px solid #3a3a3c">
<div style="font-size:32px;margin-bottom:4px">${stats.totalDays}</div>
<div style="font-size:12px;color:#8E8E93;margin-bottom:4px">Trainingstage (30T)</div>
<div style="font-size:10px;color:#34C759">${stats.restDays} Ruhetage</div>
</div>
</div>`;

// Calendar Heatmap with weekday labels
h+=`<div style="background:linear-gradient(145deg,#2c2c2e,#323234);padding:14px;border-radius:14px;margin-bottom:16px;border:1px solid #3a3a3c">
<div style="font-size:14px;font-weight:600;margin-bottom:12px">Letzte 4 Wochen</div>
<div style="display:grid;grid-template-columns:20px repeat(7,1fr);gap:3px">
<div></div>`;
// Weekday headers
['Mo','Di','Mi','Do','Fr','Sa','So'].forEach(day=>{
h+=`<div style="text-align:center;font-size:10px;color:#8E8E93">${day}</div>`;
});
// Empty cell for alignment
const startDate=new Date();
startDate.setDate(startDate.getDate()-27);
const startDay=(startDate.getDay()+6)%7; // Monday = 0
for(let e=0;e<startDay;e++){
if(e===0)h+=`<div style="font-size:10px;color:#8E8E93;display:flex;align-items:center">W1</div>`;
h+=`<div></div>`;
}
// Calendar cells
let currentWeek=1;
for(let i=27;i>=0;i--){
const date=new Date();
date.setDate(date.getDate()-i);
const dateStr=date.toISOString().split('T')[0];
const dayData=w[dateStr];
const dayOfWeek=(date.getDay()+6)%7;
if(dayOfWeek===0&&i<27){
currentWeek++;
h+=`<div style="font-size:10px;color:#8E8E93;display:flex;align-items:center">W${currentWeek}</div>`;
}
let color='#1c1c1e';
let emoji='';
let title=date.toLocaleDateString('de',{day:'2-digit',month:'2-digit'});
if(dayData){
if(dayData.rest)color='#5E5CE6',emoji='😴';
else if(dayData.e&&dayData.e.length>0){
color='#34C759';
emoji='💪';
const exerciseCount=dayData.e.length;
title+=` - ${exerciseCount} Übungen`;
}
}
h+=`<div style="background:${color};aspect-ratio:1;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:12px;position:relative" title="${title}">${emoji}</div>`;
}
h+=`</div>
<div style="display:flex;gap:16px;margin-top:10px;font-size:11px;color:#8E8E93">
<span>💪 Training</span><span>😴 Ruhetag</span><span>⬜ Kein Eintrag</span>
</div>
</div>`;
h+=`</div>`;

// Exercise Progress - Enhanced with 1RM estimates
if(stats.exercises.length>0){
h+=`<div class="settings-section">
<div class="settings-title">Gewichtsentwicklung & Bestleistungen</div>`;
stats.exercises.forEach(ex=>{
const trend=ex.trend>0?'📈':ex.trend<0?'📉':'➡️';
const trendColor=ex.trend>0?'#34C759':ex.trend<0?'#FF3B30':'#8E8E93';
const improvement=ex.improvement>0?`+${ex.improvement.toFixed(1)}kg`:`${ex.improvement.toFixed(1)}kg`;
const improvementColor=ex.improvement>0?'#34C759':'#FF3B30';

h+=`<div style="background:linear-gradient(145deg,#2c2c2e,#323234);padding:14px;border-radius:14px;margin-bottom:14px;border:1px solid #3a3a3c">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
<div style="font-weight:600;font-size:17px">${ex.name}</div>
<div style="display:flex;gap:12px;align-items:center">
<span style="color:${improvementColor};font-weight:600;font-size:14px">${improvement}</span>
<span style="color:${trendColor};font-size:20px">${trend}</span>
</div>
</div>
<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:12px">
<div style="text-align:center;background:#1c1c1e;padding:8px;border-radius:10px">
<div style="font-size:10px;color:#8E8E93;margin-bottom:4px">Start</div>
<div style="font-size:16px;font-weight:700">${ex.firstWeight}kg</div>
</div>
<div style="text-align:center;background:#1c1c1e;padding:8px;border-radius:10px">
<div style="font-size:10px;color:#8E8E93;margin-bottom:4px">Aktuell</div>
<div style="font-size:16px;font-weight:700;color:#007AFF">${ex.lastWeight}kg</div>
</div>
<div style="text-align:center;background:#1c1c1e;padding:8px;border-radius:10px">
<div style="font-size:10px;color:#8E8E93;margin-bottom:4px">Maximum</div>
<div style="font-size:16px;font-weight:700;color:#34C759">${ex.maxWeight}kg</div>
</div>
<div style="text-align:center;background:#1c1c1e;padding:8px;border-radius:10px">
<div style="font-size:10px;color:#8E8E93;margin-bottom:4px">1RM (est)</div>
<div style="font-size:16px;font-weight:700;color:#FF9500">${ex.oneRM}kg</div>
</div>
</div>`;

// Personal Records section
if(ex.records&&ex.records.length>0){
h+=`<div style="margin-bottom:12px;padding:10px;background:#1c1c1e;border-radius:10px">
<div style="font-size:12px;color:#8E8E93;margin-bottom:8px;font-weight:600">🏆 PERSÖNLICHE REKORDE</div>`;
ex.records.forEach(rec=>{
h+=`<div style="display:flex;justify-content:space-between;font-size:13px;padding:4px 0;border-bottom:1px solid #2c2c2e">
<span style="color:#8E8E93">${rec.reps} Wdh</span>
<span style="font-weight:600">${rec.weight}kg</span>
<span style="color:#007AFF;font-size:11px">${new Date(rec.date).toLocaleDateString('de',{day:'2-digit',month:'2-digit',year:'2-digit'})}</span>
</div>`;
});
h+=`</div>`;
}

// Enhanced Graph
if(ex.history.length>1){
h+=`<div style="margin-top:12px;height:120px;position:relative;background:#1c1c1e;border-radius:10px;padding:10px">`;
const max=Math.max(...ex.history.map(h=>h.weight));
const min=Math.min(...ex.history.map(h=>h.weight));
const range=max-min||1;

// Draw grid lines and labels
h+=`<svg style="position:absolute;inset:0;width:100%;height:100%">`;
// Y-axis labels
for(let i=0;i<=4;i++){
const y=(i/4)*100;
const weight=(max-(i/4)*range).toFixed(0);
h+=`<line x1="10%" y1="${y}%" x2="90%" y2="${y}%" stroke="#3a3a3c" stroke-width="0.5" opacity="0.3"/>
<text x="5%" y="${y+2}%" fill="#8E8E93" font-size="9" text-anchor="end">${weight}</text>`;
}
// Draw the line graph with fill
let pathData='M';
let fillPath='M10 100';
ex.history.forEach((point,i)=>{
const x=10+((i/(ex.history.length-1))*80);
const y=100-((point.weight-min)/range)*90-5;
if(i===0){
pathData+=`${x} ${y}`;
fillPath+=` L${x} ${y}`;
}else{
pathData+=` L${x} ${y}`;
fillPath+=` L${x} ${y}`;
}
});
fillPath+=` L90 100 Z`;
h+=`<path d="${fillPath}" fill="url(#gradient${ex.name.replace(/\s/g,'')})" opacity="0.2"/>`;
h+=`<path d="${pathData}" stroke="#007AFF" stroke-width="2.5" fill="none"/>`;
// Gradient definition
h+=`<defs><linearGradient id="gradient${ex.name.replace(/\s/g,'')}" x1="0%" y1="0%" x2="0%" y2="100%">
<stop offset="0%" style="stop-color:#007AFF;stop-opacity:0.8"/>
<stop offset="100%" style="stop-color:#007AFF;stop-opacity:0"/>
</linearGradient></defs>`;
// Draw points and labels
ex.history.forEach((point,i)=>{
const x=10+((i/(ex.history.length-1))*80);
const y=100-((point.weight-min)/range)*90-5;
const isMax=point.weight===ex.maxWeight;
const isLast=i===ex.history.length-1;
h+=`<circle cx="${x}%" cy="${y}%" r="${isMax?'5':'4'}" fill="${isMax?'#34C759':'#007AFF'}" stroke="#1c1c1e" stroke-width="2"/>`;
// Show weight value for max
if(isMax){
h+=`<text x="${x}%" y="${y-8}%" text-anchor="middle" fill="#34C759" font-size="10" font-weight="600">${point.weight}kg</text>`;
}
});
h+=`</svg>`;
// Date labels
h+=`<div style="display:flex;justify-content:space-between;margin-top:105px;font-size:9px;color:#8E8E93;padding:0 10%">
<span>${new Date(ex.history[0].date).toLocaleDateString('de',{day:'2-digit',month:'2-digit'})}</span>
<span>${new Date(ex.history[Math.floor(ex.history.length/2)].date).toLocaleDateString('de',{day:'2-digit',month:'2-digit'})}</span>
<span>${new Date(ex.history[ex.history.length-1].date).toLocaleDateString('de',{day:'2-digit',month:'2-digit'})}</span>
</div>`;
h+=`</div>`;

// Training frequency and volume
const daysBetween=Math.floor((new Date(ex.history[ex.history.length-1].date)-new Date(ex.history[0].date))/(1000*60*60*24));
const frequency=daysBetween>0?(ex.history.length/daysBetween*7).toFixed(1):0;
const totalVolume=ex.totalVolume||0;
const avgVolume=ex.avgVolume||0;
h+=`<div style="margin-top:12px;padding-top:12px;border-top:1px solid #3a3a3c;display:grid;grid-template-columns:repeat(3,1fr);gap:8px;font-size:12px">
<div style="text-align:center">
<div style="color:#8E8E93">Frequenz</div>
<div style="font-weight:600">⌀ ${frequency}x/Woche</div>
</div>
<div style="text-align:center">
<div style="color:#8E8E93">Steigerung</div>
<div style="font-weight:600;color:${improvementColor}">${((ex.improvement/ex.firstWeight)*100).toFixed(0)}%</div>
</div>
<div style="text-align:center">
<div style="color:#8E8E93">Trainings</div>
<div style="font-weight:600">${ex.history.length}x</div>
</div>
</div>`;
}else{
h+=`<div style="padding:20px;text-align:center;color:#8E8E93;font-size:13px;background:#1c1c1e;border-radius:10px">Noch nicht genug Daten für Graph</div>`;
}
h+=`</div>`;
});
h+=`</div>`;
}else{
h+=`<div class="empty">
<div class="empty-text">Noch keine Trainingsdaten</div>
<small>Starte dein Training um Fortschritt zu sehen</small>
</div>`;
}

h+=`<button class="modal-btn secondary" onclick="this.parentElement.parentElement.remove()">Schließen</button>
</div>`;
m.innerHTML=h;
document.body.appendChild(m);
}

function calculateStats(){
const stats={
streak:0,
streakStart:null,
totalDays:0,
restDays:0,
exercises:[]
};

// Calculate streak with start date
let streak=0;
let streakStart=null;
const today=new Date();
for(let i=0;i<365;i++){
const date=new Date(today);
date.setDate(date.getDate()-i);
const dateStr=date.toISOString().split('T')[0];
const dayData=w[dateStr];
if(dayData&&(dayData.rest||(dayData.e&&dayData.e.length>0))){
if(i===streak){
streak++;
streakStart=dateStr;
}else if(streak>0)break;
}else if(i===0){
// Today is empty, check yesterday
}else if(streak>0){
break;
}
}
stats.streak=streak;
stats.streakStart=streakStart;

// Count training and rest days in last 30 days
for(let i=0;i<30;i++){
const date=new Date();
date.setDate(date.getDate()-i);
const dateStr=date.toISOString().split('T')[0];
if(w[dateStr]){
if(w[dateStr].e&&w[dateStr].e.length>0){
stats.totalDays++;
}else if(w[dateStr].rest){
stats.restDays++;
}
}
}

// Exercise progress with enhanced tracking and 1RM calculation
const exerciseMap={};
Object.keys(w).forEach(date=>{
if(w[date]&&w[date].e){
w[date].e.forEach(ex=>{
if(!exerciseMap[ex.n])exerciseMap[ex.n]={history:[],records:[],name:ex.n};
// Find max weight for this exercise on this date
const maxWeight=Math.max(...ex.s.map(s=>parseFloat(s.w)||0));
if(maxWeight>0){
exerciseMap[ex.n].history.push({date,weight:maxWeight});
// Track personal records by rep range
ex.s.forEach(set=>{
if(set.w&&set.r){
const weight=parseFloat(set.w);
const reps=parseInt(set.r);
if(weight>0&&reps>0){
// Check if this is a PR for this rep range
const existing=exerciseMap[ex.n].records.find(r=>r.reps===reps);
if(!existing||existing.weight<weight){
if(existing){
existing.weight=weight;
existing.date=date;
}else{
exerciseMap[ex.n].records.push({reps,weight,date});
}
}
}
}
});
}
});
}
});

Object.values(exerciseMap).forEach(ex=>{
if(ex.history.length>0){
ex.history.sort((a,b)=>a.date.localeCompare(b.date));
ex.firstWeight=ex.history[0].weight;
ex.lastWeight=ex.history[ex.history.length-1].weight;
ex.maxWeight=Math.max(...ex.history.map(h=>h.weight));
ex.improvement=ex.lastWeight-ex.firstWeight;

// Calculate estimated 1RM using Epley formula
// 1RM = weight × (1 + reps/30)
let estimated1RM=ex.maxWeight; // Default to max weight
ex.records.forEach(rec=>{
if(rec.reps<=12){ // Only use lower rep ranges for accuracy
const rm=rec.weight*(1+rec.reps/30);
if(rm>estimated1RM)estimated1RM=rm;
}
});
ex.oneRM=Math.round(estimated1RM);

// Sort records by reps
ex.records.sort((a,b)=>a.reps-b.reps);
// Keep only best 5 records
ex.records=ex.records.slice(0,5);

// Calculate trend
if(ex.history.length>1){
const recent=ex.history.slice(-3);
const older=ex.history.slice(-6,-3);
if(older.length>0){
const recentAvg=recent.reduce((a,b)=>a+b.weight,0)/recent.length;
const olderAvg=older.reduce((a,b)=>a+b.weight,0)/older.length;
ex.trend=recentAvg>olderAvg?1:recentAvg<olderAvg?-1:0;
}else{
ex.trend=ex.lastWeight>ex.firstWeight?1:ex.lastWeight<ex.firstWeight?-1:0;
}
}else{
ex.trend=0;
}
stats.exercises.push(ex);
}
});

// Sort exercises by most recent training
stats.exercises.sort((a,b)=>b.history[b.history.length-1].date.localeCompare(a.history[a.history.length-1].date));

return stats;
}

// Open Add Modal with day template option if available
function openAddModal(){
// Check if day templates exist and add them to the modal
const dayOption = $('day-template-option');
if(dts.length>0){
let h='<div style="margin-top:10px"><div style="font-size:12px;color:#8E8E93;margin-bottom:8px;text-align:center">ODER</div>';
h+='<div class="choice-card" onclick="showDayTemplates()" style="width:100%">';
h+='<div class="choice-icon">📅</div>';
h+='<div class="choice-title">Tagesplan laden</div>';
h+='<div class="choice-desc">Kompletten Trainingsplan</div>';
h+='</div></div>';
dayOption.innerHTML=h;
}else{
dayOption.innerHTML='';
}
$('am').classList.add('open');
}

// Template Functions
function showManualAdd(){
cm('am');
$('mam').classList.add('open');
}

function showTemplateSelect(){
cm('am');
renderTemplateSelect();
$('tsm').classList.add('open');
}

function renderTemplateSelect(){
let h='';
if(et.length===0){
h='<div class="empty"><div class="empty-text">Keine Templates vorhanden</div><small>Erstelle Templates in den Einstellungen</small></div>';
}else{
et.forEach((t,i)=>{
h+=`<div class="template-item">
<div class="template-icon">💪</div>
<div class="template-info">
<div class="template-name">${t.n}</div>
<div class="template-details">${t.s} Sätze × ${t.r} • ${t.m}</div>
</div>
<button class="template-btn use" onclick="useExerciseTemplate(${i})">→</button>
</div>`;
});
}
$('template-select-list').innerHTML=h;
}

function useExerciseTemplate(i){
const t=et[i];
if(t){
const k=dt;
if(!w[k])w[k]={e:[]};
w[k].e.push({
n:t.n,
r:t.r,
t:t.t||'kg',
m:t.m,
s:Array(t.s).fill().map(()=>({w:'',r:'',d:0}))
});
cm('tsm');s();r();
}
}

function showDayTemplates(){
cm('am'); // Close the add modal if open
let h='<div class="modal open" onclick="if(event.target===this)this.remove()"><div class="modal-content">';
h+='<div class="modal-header"><h3>Tagesplan wählen</h3><button class="close-modal" onclick="this.parentElement.parentElement.parentElement.remove()">×</button></div>';
if(dts.length===0){
h+='<div class="empty"><div class="empty-text">Keine Tagespläne vorhanden</div></div>';
}else{
dts.forEach((t,i)=>{
const exCount=t.exercises?t.exercises.length:0;
h+=`<div class="template-item">
<div class="template-icon day">📅</div>
<div class="template-info">
<div class="template-name">${t.n}</div>
<div class="template-details">${exCount} Übungen</div>
</div>
<button class="template-btn use" onclick="useDayTemplate(${i});this.parentElement.parentElement.parentElement.remove()">→</button>
</div>`;
});
}
h+='<button class="modal-btn secondary" onclick="this.parentElement.parentElement.remove()">Abbrechen</button>';
h+='</div></div>';
document.body.insertAdjacentHTML('beforeend',h);
}

function useDayTemplate(i){
const t=dts[i];
if(t&&t.exercises){
const k=dt;
if(!w[k])w[k]={e:[]};
t.exercises.forEach(ex=>{
w[k].e.push({
n:ex.n,
r:ex.r,
t:ex.t||'kg',
m:ex.m,
s:Array(ex.s).fill().map(()=>({w:'',r:'',d:0}))
});
});
s();r();
}
}

function saveAsTemplate(){
const n=$('nn').value.trim();
const st=parseInt($('ns').value)||3;
const rp=$('nr').value||'8-12';
const tp=$('nt').value||'kg';
const mg=$('nm').value||'Andere';
if(n){
et.push({n,s:st,r:rp,t:tp,m:mg});
s();
showToast('✅ Als Template gespeichert!');
}
}

// Templates Management
function openTemplates(){
cm('sm');
renderTemplates();
$('tm').classList.add('open');
}

function switchTab(tab){
currentTab=tab;
$('tab-ex').classList.toggle('active',tab==='ex');
$('tab-day').classList.toggle('active',tab==='day');
$('add-template-btn').textContent=tab==='ex'?'➕ Übungs-Template':'➕ Tagesplan';
renderTemplates();
}

function renderTemplates(){
let h='';
const templates=currentTab==='ex'?et:dts;
if(templates.length===0){
h=`<div class="empty">
<div class="empty-text">Keine ${currentTab==='ex'?'Übungs-Templates':'Tagespläne'} vorhanden</div>
<small>Klicke unten um zu erstellen</small>
</div>`;
}else{
templates.forEach((t,i)=>{
if(currentTab==='ex'){
h+=`<div class="template-item">
<div class="template-icon">💪</div>
<div class="template-info">
<div class="template-name">${t.n}</div>
<div class="template-details">${t.s} Sätze × ${t.r} • ${t.m}</div>
</div>
<div class="template-actions">
<button class="template-btn edit" onclick="editTemplate(${i})">✏️</button>
<button class="template-btn delete" onclick="deleteTemplate(${i})">×</button>
</div>
</div>`;
}else{
const exCount=t.exercises?t.exercises.length:0;
h+=`<div class="template-item">
<div class="template-icon day">📅</div>
<div class="template-info">
<div class="template-name">${t.n}</div>
<div class="template-details">${exCount} Übungen</div>
</div>
<div class="template-actions">
<button class="template-btn edit" onclick="editTemplate(${i})">✏️</button>
<button class="template-btn delete" onclick="deleteTemplate(${i})">×</button>
</div>
</div>`;
}
});
}
$('template-list').innerHTML=h;
}

function openAddTemplate(){
if(currentTab==='ex'){
openAddExerciseTemplate();
}else{
openAddDayTemplate();
}
}

function openAddExerciseTemplate(){
cm('tm');
const m=document.createElement('div');
m.className='modal open';
m.onclick=e=>{if(e.target===m)m.remove()};
m.innerHTML=`<div class="modal-content">
<div class="modal-header">
<h3>${editingTemplate!==null?'Template bearbeiten':'Neues Übungs-Template'}</h3>
<button class="close-modal" onclick="this.parentElement.parentElement.parentElement.remove()">×</button>
</div>
<div class="form-group"><label class="label">Name</label><input type="text" id="tname" placeholder="z.B. Bankdrücken" value="${editingTemplate!==null?et[editingTemplate].n:''}" autocomplete="off"></div>
<div class="form-group"><label class="label">Sätze</label><input type="number" id="tsets" value="${editingTemplate!==null?et[editingTemplate].s:'3'}" min="1" max="10" inputmode="numeric"></div>
<div class="form-group"><label class="label">Wiederholungen</label><input type="text" id="treps" value="${editingTemplate!==null?et[editingTemplate].r:'8-12'}" placeholder="8-12" autocomplete="off"></div>
<div class="form-group"><label class="label">Typ</label><select id="ttype"><option value="kg" ${editingTemplate!==null&&et[editingTemplate].t==='kg'?'selected':''}>Gewicht (kg)</option><option value="m" ${editingTemplate!==null&&et[editingTemplate].t==='m'?'selected':''}>Distanz (m)</option><option value="min" ${editingTemplate!==null&&et[editingTemplate].t==='min'?'selected':''}>Zeit (min)</option></select></div>
<div class="form-group"><label class="label">Muskelgruppe</label><select id="tmuscle">${['Brust','Rücken','Beine','Schultern','Arme','Bauch','Cardio','Andere'].map(m=>`<option value="${m}" ${editingTemplate!==null&&et[editingTemplate].m===m?'selected':''}>${m}</option>`).join('')}</select></div>
<button class="modal-btn primary" onclick="saveExerciseTemplate()">${editingTemplate!==null?'Speichern':'Template erstellen'}</button>
<button class="modal-btn secondary" onclick="editingTemplate=null;this.parentElement.parentElement.remove()">Abbrechen</button>
</div>`;
document.body.appendChild(m);
}

function saveExerciseTemplate(){
const n=$('tname').value.trim();
const sets=parseInt($('tsets').value)||3;
const reps=$('treps').value||'8-12';
const type=$('ttype').value||'kg';
const muscle=$('tmuscle').value||'Andere';
if(n){
if(editingTemplate!==null){
et[editingTemplate]={n,s:sets,r:reps,t:type,m:muscle};
editingTemplate=null;
showToast('✅ Template aktualisiert!');
}else{
et.push({n,s:sets,r:reps,t:type,m:muscle});
showToast('✅ Template erstellt!');
}
s();  // This calls the save function
// Close the creation modal
const modals=document.querySelectorAll('.modal.open');
modals.forEach(m=>{
if(m.querySelector('#tname'))m.remove();
});
// Refresh and reopen template list
renderTemplates();
$('tm').classList.add('open');
}
}

function openAddDayTemplate(){
cm('tm');
const m=document.createElement('div');
m.className='modal open';
m.id='day-template-modal';
m.onclick=e=>{if(e.target===m){editingTemplate=null;window.tempDayExercises=null;m.remove()}};
window.tempDayExercises=editingTemplate!==null&&dts[editingTemplate]&&dts[editingTemplate].exercises?[...dts[editingTemplate].exercises]:[];
let h=`<div class="modal-content">
<div class="modal-header">
<h3>${editingTemplate!==null?'Tagesplan bearbeiten':'Neuer Tagesplan'}</h3>
<button class="close-modal" onclick="editingTemplate=null;window.tempDayExercises=null;this.parentElement.parentElement.parentElement.remove()">×</button>
</div>
<div class="form-group"><label class="label">Name</label><input type="text" id="dname" placeholder="z.B. Push Day" value="${editingTemplate!==null&&dts[editingTemplate]?dts[editingTemplate].n:''}" autocomplete="off"></div>
<div class="form-group"><label class="label">Übungen</label><div id="day-exercises">`;
// Initial render of exercises
if(window.tempDayExercises.length>0){
window.tempDayExercises.forEach((ex,i)=>{
h+=`<div class="template-item">
<div class="template-info">
<div class="template-name">${ex.n}</div>
<div class="template-details">${ex.s} Sätze × ${ex.r} • ${ex.m}</div>
</div>
<button class="template-btn delete" onclick="removeFromDayTemplate(${i})">×</button>
</div>`;
});
}else{
h+='<div style="padding:10px;color:#8E8E93;text-align:center">Noch keine Übungen</div>';
}
h+=`</div></div>
<button class="modal-btn purple" onclick="addExerciseToDayTemplate()">➕ Übung hinzufügen</button>
<button class="modal-btn primary" onclick="saveDayTemplate()">${editingTemplate!==null?'Speichern':'Tagesplan erstellen'}</button>
<button class="modal-btn secondary" onclick="editingTemplate=null;window.tempDayExercises=null;this.parentElement.parentElement.remove()">Abbrechen</button>
</div>`;
m.innerHTML=h;
document.body.appendChild(m);
}

function renderDayExercises(){
const container=$('day-exercises');
if(!container)return; // Safety check if element doesn't exist
let h='';
if(window.tempDayExercises&&window.tempDayExercises.length>0){
window.tempDayExercises.forEach((ex,i)=>{
h+=`<div class="template-item">
<div class="template-info">
<div class="template-name">${ex.n}</div>
<div class="template-details">${ex.s} Sätze × ${ex.r} • ${ex.m}</div>
</div>
<button class="template-btn delete" onclick="removeFromDayTemplate(${i})">×</button>
</div>`;
});
}else{
h='<div style="padding:10px;color:#8E8E93;text-align:center">Noch keine Übungen</div>';
}
container.innerHTML=h;
}

function addExerciseToDayTemplate(){
const parent=document.getElementById('day-template-modal');
if(parent)parent.style.display='none';
const m=document.createElement('div');
m.className='modal open';
m.onclick=e=>{if(e.target===m){m.remove();if(parent)parent.style.display='flex';}};
let h=`<div class="modal-content">
<div class="modal-header">
<h3>Übung auswählen</h3>
<button class="close-modal" onclick="this.parentElement.parentElement.parentElement.remove();const p=document.getElementById('day-template-modal');if(p)p.style.display='flex'">×</button>
</div>`;
if(et.length>0){
h+='<div class="template-list">';
et.forEach((t,i)=>{
h+=`<div class="template-item">
<div class="template-icon">💪</div>
<div class="template-info">
<div class="template-name">${t.n}</div>
<div class="template-details">${t.s} Sätze × ${t.r} • ${t.m}</div>
</div>
<button class="template-btn use" onclick="selectForDayTemplate(${i})">+</button>
</div>`;
});
h+='</div>';
}else{
h+='<div class="empty"><div class="empty-text">Keine Übungs-Templates vorhanden</div><small>Erstelle zuerst Übungs-Templates</small></div>';
}
h+='<button class="modal-btn secondary" onclick="this.parentElement.parentElement.remove();const p=document.getElementById(\'day-template-modal\');if(p)p.style.display=\'flex\'">Abbrechen</button>';
h+='</div>';
m.innerHTML=h;
document.body.appendChild(m);
}

function selectForDayTemplate(i){
if(!window.tempDayExercises)window.tempDayExercises=[];
window.tempDayExercises.push({...et[i]});
showToast('✅ Übung hinzugefügt');
// Close the selection modal
const selectionModal=document.querySelector('.modal.open');
if(selectionModal&&!selectionModal.querySelector('#day-exercises')){
selectionModal.remove();
}
// Show the day template modal again
const parent=document.getElementById('day-template-modal');
if(parent){
parent.style.display='flex';
renderDayExercises();
}
}

function removeFromDayTemplate(i){
if(window.tempDayExercises){
window.tempDayExercises.splice(i,1);
showToast('❌ Übung entfernt');
// Re-render the list directly
const dayModal=document.getElementById('day-template-modal');
if(dayModal){
const container=dayModal.querySelector('#day-exercises');
if(container){
let h='';
if(window.tempDayExercises.length>0){
window.tempDayExercises.forEach((ex,idx)=>{
h+=`<div class="template-item">
<div class="template-info">
<div class="template-name">${ex.n}</div>
<div class="template-details">${ex.s} Sätze × ${ex.r} • ${ex.m}</div>
</div>
<button class="template-btn delete" onclick="removeFromDayTemplate(${idx})">×</button>
</div>`;
});
}else{
h='<div style="padding:10px;color:#8E8E93;text-align:center">Noch keine Übungen</div>';
}
container.innerHTML=h;
}
}
}
}

function saveDayTemplate(){
const n=$('dname').value.trim();
if(n&&window.tempDayExercises&&window.tempDayExercises.length>0){
if(editingTemplate!==null){
dts[editingTemplate]={n,exercises:[...window.tempDayExercises]};
editingTemplate=null;
showToast('✅ Tagesplan aktualisiert!');
}else{
dts.push({n,exercises:[...window.tempDayExercises]});
showToast('✅ Tagesplan erstellt!');
}
s();  // Save to localStorage and GitHub
window.tempDayExercises=null;
// Close the creation modal
const dayModal=document.getElementById('day-template-modal');
if(dayModal)dayModal.remove();
// Refresh and reopen template list
renderTemplates();
$('tm').classList.add('open');
}else{
showToast('⚠️ Name und mindestens eine Übung erforderlich!');
}
}

function editTemplate(i){
editingTemplate=i;
if(currentTab==='ex'){
openAddExerciseTemplate();
}else{
openAddDayTemplate();
}
}

function deleteTemplate(i){
if(confirm(`${currentTab==='ex'?'Template':'Tagesplan'} wirklich löschen?`)){
if(currentTab==='ex'){
et.splice(i,1);
}else{
dts.splice(i,1);
}
s();renderTemplates();
}
}

// Modal Functions
function cm(i){$(i).classList.remove('open')}
function openSettings(){
updateGithubStatus();
$('sm').classList.add('open');
}

function updateGithubStatus(){
const status = $('github-status');
if(status && localStorage.getItem('ght')){
const lastSync = localStorage.getItem('gls');
if(lastSync){
const date = new Date(lastSync);
const time = date.toLocaleTimeString('de', {hour: '2-digit', minute: '2-digit'});
const day = date.toLocaleDateString('de', {day: '2-digit', month: '2-digit'});
status.innerHTML = `✅ Aktiv • Sync: ${day} ${time}`;
} else {
status.textContent = '✅ Aktiviert';
}
} else {
status.textContent = 'Automatische Synchronisation einrichten';
}
}

// Export
function xp(){
cm('sm');
const data={w,et,dts};
const d=JSON.stringify(data,null,2);
const b=new Blob([d],{type:'application/json'});
const u=URL.createObjectURL(b);
const a=document.createElement('a');
a.href=u;
a.download=`gym-${dt}.json`;
a.click();
}

// Import
function im(){
cm('sm');
const i=document.createElement('input');
i.type='file';
i.accept='.json';
i.onchange=e=>{
const r=new FileReader();
r.onload=ev=>{
try{
const data=JSON.parse(ev.target.result);
if(data.w)w=data.w;
else if(!data.et&&!data.dts)w=data;
if(data.et)et=data.et;
if(data.dts)dts=data.dts;
s();r();showToast('✅ Import erfolgreich!');
}catch{showToast('❌ Fehler beim Import')}
};
r.readAsText(e.target.files[0]);
};
i.click();
}

// GitHub Dialog
function cs(){
cm('sm');
setTimeout(()=>{
const m=document.createElement('div');
m.className='modal open';
m.onclick=e=>{if(e.target===m)m.remove()};
m.innerHTML=`<div class="modal-content">
<div class="modal-header">
<h3>GitHub Sync</h3>
<button class="close-modal" onclick="this.parentElement.parentElement.parentElement.remove()">×</button>
</div>
<div class="form-group"><label class="label">Token</label><input type="password" id="gt" placeholder="ghp_..." value="${localStorage.getItem('ght')||''}" autocomplete="off"></div>
<div class="form-group"><label class="label">Username</label><input type="text" id="gu" placeholder="dein-username" value="${localStorage.getItem('ghu')||''}" autocomplete="off"></div>
<div class="form-group"><label class="label">Repository</label><input type="text" id="gr" placeholder="Workout-tracker" value="${localStorage.getItem('ghr')||'Workout-tracker'}" autocomplete="off"></div>
<button class="modal-btn primary" onclick="gss()">Speichern & Aktivieren</button>
${localStorage.getItem('ght')?'<button class="modal-btn success" onclick="ghl().then(()=>{r();alert(\'✅ Von GitHub geladen\')})">Von GitHub laden</button>':''}
${localStorage.getItem('ght')?'<button class="modal-btn danger" onclick="if(confirm(\'GitHub Sync wirklich deaktivieren?\')){localStorage.removeItem(\'ght\');localStorage.removeItem(\'ghu\');localStorage.removeItem(\'ghr\');alert(\'Deaktiviert\');this.parentElement.parentElement.remove()}">Deaktivieren</button>':''}
<button class="modal-btn secondary" onclick="this.parentElement.parentElement.remove()">Abbrechen</button>
</div>`;
document.body.appendChild(m);
},100);
}

function gss(){
try{
const t=$('gt').value,u=$('gu').value,r=$('gr').value;
if(t&&u){
localStorage.setItem('ght',t);
localStorage.setItem('ghu',u);
localStorage.setItem('ghr',r);
ghl().then(()=>{r();ghs()});
showToast('✅ GitHub Sync aktiviert!');
const modal=document.querySelector('.modal.open');
if(modal)modal.remove();
}
}catch(e){
console.log('GitHub save error:',e);
showToast('❌ Fehler beim Speichern');
}
}

async function ghs(){
const t=localStorage.getItem('ght'),u=localStorage.getItem('ghu'),r=localStorage.getItem('ghr')||'Workout-tracker';
if(!t||!u)return;
try{
const data={w,et,dts,d:new Date()};
const d=btoa(unescape(encodeURIComponent(JSON.stringify(data))));
const s=await gsha();
await fetch(`https://api.github.com/repos/${u}/${r}/contents/data.json`,{
method:'PUT',
headers:{'Authorization':`token ${t}`},
body:JSON.stringify({message:`Update ${new Date().toLocaleString('de')}`,content:d,sha:s})
});
localStorage.setItem('gls', new Date().toISOString());
updateGithubStatus();
}catch(e){console.log('GitHub save error:',e)}
}

async function gsha(){
const t=localStorage.getItem('ght'),u=localStorage.getItem('ghu'),r=localStorage.getItem('ghr')||'Workout-tracker';
try{
const res=await fetch(`https://api.github.com/repos/${u}/${r}/contents/data.json`,{
headers:{'Authorization':`token ${t}`}
});
if(res.ok)return(await res.json()).sha;
}catch{}
}

async function ghl(){
const t=localStorage.getItem('ght'),u=localStorage.getItem('ghu'),r=localStorage.getItem('ghr')||'Workout-tracker';
if(!t||!u)return;
try{
const res=await fetch(`https://api.github.com/repos/${u}/${r}/contents/data.json`,{
headers:{'Authorization':`token ${t}`}
});
if(res.ok){
const d=await res.json();
const c=JSON.parse(decodeURIComponent(escape(atob(d.content))));
if(c.w){
w=c.w;
et=c.et||[];
dts=c.dts||[];
const data={w,et,dts};
localStorage.setItem('w',JSON.stringify(data));
localStorage.setItem('gls', new Date().toISOString());
updateGithubStatus();
console.log('✅ Von GitHub geladen');
}
}else if(res.status===404){
console.log('📝 Erstelle neue data.json mit leeren Daten');
w={};et=[];dts=[];
await ghs();
}
}catch(e){console.log('GitHub load error:',e)}
}

// Init
fd();
if(localStorage.getItem('ght')){
ghl().then(()=>r());
}else{
l();
r();
}

// iOS optimizations
document.addEventListener('touchmove',e=>{if(e.scale!==1)e.preventDefault()},{passive:false});
</script>
</body>
</html>
